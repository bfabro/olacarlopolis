<!DOCTYPE html>

<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1" name="viewport"/>
<title>Lanches – Pedido por WhatsApp (MVP)</title>
<style>
    * {
      box-sizing: border-box;
    }

    .oc-lanches-wrap {
      max-width: 1100px;
      margin: 24px auto;
      padding: 16px;
    }

    .oc-grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 16px;
    }

    @media (min-width: 980px) {
      .oc-grid {
        grid-template-columns: 1.5fr 1fr;
      }
    }

    .oc-card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 16px;
    }

    .oc-title {
      font-size: 22px;
      margin: 0 0 8px;
    }

    .oc-sub {
      color: var(--muted);
      font-size: 14px;
      margin-bottom: 16px;
    }

    .oc-prod-list {
      display: grid;
      grid-template-columns: 1fr;
      gap: 12px;
    }

    @media (min-width: 600px) {
      .oc-prod-list {
        grid-template-columns: 1fr 1fr;
      }
    }

    .oc-prod {
      display: grid;
      grid-template-columns: 1fr auto;
      gap: 10px;
      align-items: center;
      background: #12161d;
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 12px;
    }

    .oc-prod h4 {
      margin: 0 0 6px;
      font-size: 16px;
    }

    .oc-prod p {
      margin: 0;
      color: var(--muted);
      font-size: 13px;
    }

    .oc-price {
      font-weight: 600;
      font-size: 14px;
    }

    .oc-add {
      background: var(--brand);
      color: white;
      border: none;
      border-radius: 10px;
      padding: 8px 10px;
      cursor: pointer;
      font-weight: 600;
    }

    .oc-cart {
      position: sticky;
      top: 16px;
    }

    .oc-cart-empty {
      color: var(--muted);
      font-size: 14px;
    }

    .oc-cart-line {
      display: grid;
      grid-template-columns: auto 1fr auto;
      align-items: center;
      gap: 10px;
      padding: 10px 0;
      border-bottom: 1px dashed var(--border);
    }

    .oc-qty {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      background: #dfdfdf;
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 4px;
    }

    .oc-qty button {
      background: transparent;
      border: none;
      color: var(--text);
      font-size: 18px;
      width: 26px;
      height: 26px;
      cursor: pointer;
    }

    .oc-cart-totals {
      margin-top: 12px;
      font-size: 14px;
    }

    .oc-cart-totals div {
      display: flex;
      justify-content: space-between;
      margin: 4px 0;
    }

    .oc-total {
      font-weight: 800;
      font-size: 16px;
    }

    .oc-field {
      margin-bottom: 10px;
    }

    .oc-field label {
      display: block;
      font-size: 13px;
      color: var(--muted);
      margin-bottom: 6px;
    }

    .oc-field input,
    .oc-field select,
    .oc-field textarea {
      width: 100%;
      background: #0f141b;
      color: var(--text);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 10px 12px;
      font: inherit;
    }

    .oc-flex {
      display: grid;
      gap: 10px;
      grid-template-columns: 1fr;
    }

    @media (min-width: 700px) {
      .oc-flex.cols-2 {
        grid-template-columns: 1fr 1fr;
      }
    }

    .oc-send {
      width: 100%;
      margin-top: 12px;
      padding: 14px;
      background: var(--ok);
      color: #07120a;
      border: none;
      border-radius: 12px;
      font-size: 16px;
      font-weight: 800;
      cursor: pointer;
    }

    .oc-send[disabled] {
      filter: grayscale(.7);
      opacity: .7;
      cursor: not-allowed;
    }

    .oc-badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 10px;
      border-radius: 999px;
      background: var(--chip);
      color: var(--chip-text);
      font-size: 12px;
      font-weight: 600;
    }

    .oc-badge.warn {
      background: #392a14;
      color: #ffd8a8;
      border: 1px solid #513a18;
    }

    .oc-badge.ok {
      background: #142f1d;
      color: #b8ffcf;
      border: 1px solid #164a27;
    }

    .oc-badge.danger {
      background: #3a1616;
      color: #ffc9c9;
      border: 1px solid #532222;
    }

    .oc-mini {
      font-size: 12px;
      color: var(--muted);
    }

    dialog.oc-modal {
      width: min(520px, 96vw);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 0;
      background: var(--card);
      color: var(--text);
    }

    .oc-modal header {
      padding: 14px 16px;
      border-bottom: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .oc-modal .oc-content {
      padding: 14px 16px;
    }

    .oc-modal .oc-actions {
      padding: 14px 16px;
      border-top: 1px solid var(--border);
      display: flex;
      gap: 8px;
      justify-content: flex-end;
    }

    .oc-chip {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 10px;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: #f0f0f0;
      margin: 4px 6px 4px 0;
    }

    .oc-chip input {
      transform: scale(1.1);
    }

    .oc-btn-sec {
      background: #0f141b;
      color: var(--text);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 10px 12px;
      cursor: pointer;
    }

    .oc-btn-pri {
      background: var(--brand);
      color: #fff;
      border: none;
      border-radius: 10px;
      padding: 10px 12px;
      cursor: pointer;
      font-weight: 700;
    }

    .oc-right {
      text-align: right;
    }

    .oc-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
    }

    .oc-muted {
      color: var(--muted);
    }
  </style>
<link href="style.css" rel="stylesheet"/>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&amp;family=Montserrat:wght@800&amp;display=swap" rel="stylesheet"/>
<style>
    /* --- Overrides to match Olá Carlópolis theme --- */
    :root {
      /* use site variables from style.css if present */
      --oc-card-bg: var(--white-color, #fff);
      --oc-border: rgba(0, 0, 0, 0.08);
      --oc-text: #222;
      --oc-muted: var(--grey-color, #707070);
      --oc-brand: var(--blue-color, #4070f4);
      --oc-ok: #25D366;
      /* WhatsApp green */
    }

    body {
      background: #f4f4f4;
      /* matches .content_area bg in site */
      color: var(--oc-text);
      font-family: "Poppins", system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
    }

    /* Container aligns with site .content_area spacing */
    .oc-page {
      margin: 12px auto 24px auto;
      padding: 0 12px;
      max-width: 1200px;
    }

    /* Card look like site cards */
    .oc-card {
      background: var(--oc-card-bg) !important;
      border: 1px solid var(--oc-border) !important;
      box-shadow: 0 6px 20px rgba(0, 0, 0, 0.06);
      border-radius: 14px !important;
    }

    /* Headings use Montserrat heavy like site highlights */
    .oc-title,
    h3.oc-title {
      font-family: "Montserrat", "Poppins", sans-serif;
      font-weight: 800;
      letter-spacing: .3px;
      color: #111;
    }

    .oc-sub {
      color: var(--oc-muted) !important;
    }

    /* Product cards */
    .oc-prod {
      background: #fff !important;
      border: 1px solid var(--oc-border) !important;
    }

    .oc-price {
      color: #111;
    }

    /* Buttons */
    .oc-add {
      background: var(--oc-brand) !important;
      transition: transform .06s ease, filter .2s ease;
    }

    .oc-add:hover {
      transform: translateY(-1px);
      filter: brightness(1.05);
    }

    .oc-send {
      background: var(--oc-ok) !important;
      color: #053b1a !important;
      box-shadow: 0 8px 18px rgba(37, 211, 102, .25);
      transition: transform .06s ease, filter .2s ease;
    }

    .oc-send:hover {
      transform: translateY(-1px);
      filter: brightness(1.05);
    }

    /* Inputs to match site rounded white inputs */
    .oc-field input,
    .oc-field select,
    .oc-field textarea {
      background: #fff !important;
      border: 1px solid var(--oc-border) !important;
      color: #222 !important;
      border-radius: 12px !important;
    }

    /* Badges tuned to site palette */
    .oc-badge {
      background: #eef3ff !important;
      color: #2f4fa8 !important;
      border: 1px solid #dfe7ff !important;
    }

    .oc-badge.ok {
      background: #e8f7ef !important;
      color: #1c7d43 !important;
      border-color: #cdeedb !important;
    }

    .oc-badge.danger {
      background: #fff1f1 !important;
      color: #9b1c1c !important;
      border-color: #ffd6d6 !important;
    }

    .oc-badge.warn {
      background: #fff6e8 !important;
      color: #8a5700 !important;
      border-color: #ffe3ba !important;
    }

    /* Grid tweaks for tighter look */
    .oc-lanches-wrap {
      padding: 0 !important;
    }

    .oc-grid {
      gap: 18px !important;
    }

    .oc-cart {
      top: 88px !important;
    }

    /* keep sticky under navbar */

    /* Modal polish */
    dialog.oc-modal {
      background: #fff !important;
      color: #111 !important;
      border: 1px solid var(--oc-border) !important;
      box-shadow: 0 20px 50px rgba(0, 0, 0, .18);
    }

    .oc-btn-sec {
      background: #fff !important;
      border: 1px solid var(--oc-border) !important;
    }

    .oc-btn-pri {
      background: var(--oc-brand) !important;
    }

    /* Highlight title like site .highlighted */
    h2.highlighted {
      font-family: "Montserrat", "Poppins", sans-serif;
      margin: 0 0 12px 0;
    }
  </style>
<style>
    /* Brand bar - Olá Carlópolis */
    .oc-brandbar {
      display: flex;
      align-items: center;
      gap: 10px;
      margin: 0 0 8px 0
    }

    .oc-brand {
      font-family: "Montserrat", "Poppins", sans-serif;
      font-weight: 800;
      color: var(--blue-color, #4070f4);
      text-decoration: none;
      font-size: 1.15rem;
      text-shadow: 0 0 5px rgba(64, 112, 244, .15);
    }

    .oc-brand:hover {
      text-decoration: underline
    }

    .oc-brand small {
      font-weight: 600;
      color: var(--grey-color, #707070);
      margin-left: 6px
    }
  </style>
<style>
    /* --- Cart visibility improvements --- */
    .oc-cart-line .oc-item-name {
      font-size: 17px;
      font-weight: 800;
      color: #111;
    }

    .oc-cart-line .oc-item-desc {
      font-size: 14px;
      color: #222;
      margin-top: 2px;
    }

    .oc-cart-line .oc-mini.oc-muted {
      color: #4b5563;
    }

    /* slightly darker for readability */
  </style>
<style>
    /* PIX & Foto additions */
    #pixChaveInput,
    #pixChaveShow,
    #pixCopiaCola {
      background: #fff;
      color: #111;
      border: 1px solid var(--oc-border, rgba(0, 0, 0, 0.08));
    }

    #pixCopiaCola {
      width: 100%;
      border-radius: 12px;
      padding: 10px 12px;
    }

    .oc-prod .btnFoto {
      margin-right: 8px;
    }
  </style>
<style>
    .oc-logo {
      width: 140px;
      height: 95px;
      border-radius: 12px;
      object-fit: cover;
      border: 1px solid var(--oc-border, rgba(0, 0, 0, .08));
      background: #fff;
    }

    .oc-divider {
      height: 16px;
    }

    @media (min-width: 800px) {
      .oc-logo {
        width: 140px;
        height: 80px;
      }
    }
  </style>
<style>
/* Clean, clickable product tiles */
.oc-prod {
  display: grid;
  grid-template-columns: 1fr auto;
  gap: 10px;
  align-items: center;
  background: #fff !important;
  border: 1px solid var(--oc-border) !important;
  border-radius: 12px;
  padding: 12px 14px;
  cursor: pointer;
  transition: box-shadow .15s ease, transform .06s ease;
}
.oc-prod:hover { box-shadow: 0 10px 24px rgba(0,0,0,.08); transform: translateY(-1px); }
.oc-prod h4 { margin: 0 0 4px; font-size: 16px; }
.oc-prod p { margin: 0; color: var(--oc-muted); font-size: 13px; }
.oc-prod .oc-price { font-weight: 800; font-size: 14px; color:#111 }
</style></head>
<body>
<div class="oc-page">
<div class="oc-brandbar">
<div class="logo_item"><a href="index.html" style="  font-size: 1.5rem;
               font-weight: bold;
               color: white;
               text-shadow: 0 0 5px var(--blue-color), 0 0 10px var(--blue-color), 0 0 12px var(--blue-color);
               margin :0px 0px 0px 40px" target="_self">Olá Carlópolis
        </a></div>
</div>
<h2 class="highlighted">🍔 Pedido Online 🍔 <span style="  font-size: 1.5rem;
               font-weight: bold;
               color: white;
               text-shadow: 0 0 5px var(--blue-color), 0 0 10px var(--blue-color), 0 0 12px var(--blue-color);
               margin :0px 0px 0px 40px"></span></h2>
<div class="oc-lanches-wrap" id="app">
<div class="oc-grid">
<section class="oc-card oc-store">
<div class="oc-row" style="align-items:center; gap:14px;">
<img alt="Logo do estabelecimento" class="oc-logo" id="est-logo"/>
<div>
<h2 class="oc-title" id="est-name">Loja</h2>
<span class="oc-badge warn" id="openBadge">Verificando horário…</span>
<div class="oc-sub" id="est-desc">Monte seu pedido e envie por WhatsApp.</div>
</div>
</div>
</section>
<div class="oc-divider"></div>
<section class="oc-card">
<h3 class="oc-title">Cardápio</h3>
<div class="oc-prod-list" id="prodList"></div>
</section>
<div class="oc-divider"></div>
<section class="oc-card" id="dadosCard">
<h3 class="oc-title">Dados para Entrega/Retirada</h3>
<div class="oc-field">
<label>Como você quer receber?</label>
<div class="oc-flex cols-2">
<select id="tipoPedido">
<option value="Entrega">Entrega</option>
<option value="Retirada">Retirada</option>
</select>
<select id="bairroSelect"></select>
</div>
</div>
<div class="oc-flex cols-2" id="enderecoFields">
<div class="oc-field">
<label>Endereço</label>
<input id="endereco" placeholder="Rua, avenida..." type="text"/>
</div>
<div class="oc-field">
<label>Número</label>
<input id="numeroEndereco" placeholder="Nº" type="text"/>
</div>
</div>
<div class="oc-field">
<label>Referência (opcional)</label>
<input id="referencia" placeholder="Portaria, bloco, ponto de referência" type="text"/>
</div>
<div class="oc-field oc-flex cols-2" style="margin-top:8px;">
<div>
<label>Seu nome</label>
<input id="cliNome" placeholder="Seu nome" type="text"/>
</div>
<div>
<label>Seu telefone</label>
<input id="cliFone" placeholder="(43) 9xxxx-xxxx" type="tel"/>
</div>
</div>
<div class="oc-field">
<label>Forma de pagamento</label>
<select id="pagamento">
<option value="PIX">PIX</option>
<option value="Dinheiro">Dinheiro</option>
<option value="Cartão">Cartão</option>
</select>
</div>
<div class="oc-field">
<label>Observações (opcional)</label>
<textarea id="obsGeral" placeholder="Ex.: Coca bem gelada; sem pimenta" rows="2"></textarea>
</div>
</section>
<div class="oc-divider"></div>
<section class="oc-card" id="resumoCard">
<h3 class="oc-title">Resumo do Pedido</h3>
<div class="oc-cart-empty" id="cartContainer">Seu carrinho está vazio.</div>
<div class="oc-cart-totals" id="totalsBox" style="margin-top:12px;"></div>
<div class="oc-mini oc-muted" id="minimoMsg" style="margin-top:4px;"></div>
<button class="oc-send" disabled="" id="btnEnviar">Enviar pedido pelo WhatsApp</button>
<button class="oc-btn-pri" id="btnPix" style="width:100%; margin-top:10px;">Gerar PIX (copia e cola)</button>
</section>
</div>
</div>
</div>
<!-- Modal item/adicionais -->
<dialog class="oc-modal" id="itemModal">
<header>
<strong id="mNome">Item</strong>
<button class="oc-btn-sec" onclick="document.getElementById('itemModal').close()">Fechar</button>
</header>
<div class="oc-content">
<div id="mImgWrap" style="text-align:center; margin-bottom:10px;"><img alt="Imagem do produto" id="mImg" style="max-width:100%; border-radius:12px; border:1px solid var(--oc-border, rgba(0,0,0,0.08));"/></div><div class="oc-muted" id="mDesc"></div>
<div style="margin-top:10px;">
<div style="margin:8px 0 6px; font-weight:700;">Adicionais</div>
<div id="mAdds"></div>
</div>
<div class="oc-field" style="margin-top:8px;">
<label>Observações</label>
<input id="mObs" placeholder="Ex.: sem cebola, ponto da carne" type="text"/>
</div>
<div class="oc-row" style="margin-top:10px;">
<div class="oc-qty">
<button id="mMenos">−</button>
<span id="mQtd">1</span>
<button id="mMais">+</button>
</div>
<div class="oc-right"><span class="oc-muted">Subtotal item: </span><strong id="mSubtotal">R$ 0,00</strong></div>
</div>
</div>
<div class="oc-actions">
<button class="oc-btn-pri" id="mAddBtn">Adicionar ao carrinho</button>
</div>
</dialog>
<script>
    /*******************
     * CONFIG EXEMPLO  *
     *******************/
    const EST = {

      slug: "Ki Dog",
      nome: "Ki Dog",
      logo: "images/comercios/lanchonete/kidog/perfil.png", // <-- caminho do arquivo da logo
      whatsapp: "11 98985930",
      descricao: "Atendemos Carlópolis e região. Taxas por bairro e retirada no balcão.",
      horarios: { // use 24h HH:MM-HH:MM. Dias: dom, seg, ter, qua, qui, sex, sab
        seg: "18:00-23:00",
        ter: "18:00-23:00",
        qua: "18:00-23:00",
        qui: "18:00-23:00",
        sex: "18:00-00:30",
        sab: "14:00-00:30",
        dom: "00:01-23:00"
      },
      taxasEntrega: { "Centro": 3.0, "Vila Nova": 5.0, "Jardim América": 6.0 },
      pedidoMinimo: { Entrega: 20 },
      cardapio: [
        {
          id: "xs1", nome: "X-Salada", preco: 18.9, desc: "Pão, hambúrguer 120g, queijo, alface, tomate, maionese.", adicionais: [
            { id: "bacon", nome: "Bacon", preco: 3.0 },
            { id: "cheddar", nome: "Cheddar", preco: 2.5 },
            { id: "ovo", nome: "Ovo", preco: 2.0 }
          ]
        },
        {
          id: "xb1", nome: "X-Bacon", preco: 22.9, desc: "Com bacon crocante.", adicionais: [
            { id: "bacon2x", nome: "Bacon extra", preco: 3.0 },
            { id: "cheddar", nome: "Cheddar", preco: 2.5 }
          ]
        },
        { id: "fr1", nome: "Fritas média", preco: 12.0, desc: "300g" },
        { id: "coca350", nome: "Coca 350ml", preco: 6.0 },
        { id: "guarana1l", nome: "Guaraná 1L", preco: 9.0 }
      ]
    };

    // Captura utm e mesa (se houver)
    const UTM = new URLSearchParams(location.search).get('utm') || null;
    const MESA = new URLSearchParams(location.search).get('mesa') || null;
    const IMAGENS_DIR = "images/comercios/restaurante/selaht/lanches/"; // pasta, termina com /

    const slug = s => (s || '').toLowerCase()
      .normalize('NFD').replace(/[\u0300-\u036f]/g, '')
      .replace(/[^a-z0-9]+/g, '-').replace(/(^-|-$)/g, '');
    const getFoto = (p) => p.foto || (IMAGENS_DIR + slug(p.nome) + '.jpg');
    const LOGOS_DIR = 'images/comercios/restaurante/selaht/selaht.png';
    const getLogo = (est) => est.logo || (LOGOS_DIR + slug(est.nome) + '.png');


    // PIX configuration (fixed)
    const PIX_CONFIG = {
      chave: "39075442858",   // <-- defina aqui a chave PIX fixa da loja
      nome: (EST && EST.nome) ? EST.nome.toUpperCase().slice(0, 25) : "ESTABELECIMENTO",
      cidade: "CARLOPOLIS",                 // até 15 chars, maiúsculo
      txidPrefix: "OC"                      // prefixo do TXID
    };

    const WHATS_ESTAB_FIXO = '11 98985930';

    /*******************
     * HELPERS         *
     *******************/
    const money = v => (v || 0).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });

    function normalizePhone(raw) {
      let n = (raw || "").replace(/\D/g, "");
      if (n.startsWith("0")) n = n.replace(/^0+/, "");
      if (n.startsWith("55")) return n;
      return "55" + n;
    }

    function parseHM(s) { // "18:00" -> {h:18,m:0}
      const [h, m] = s.split(":").map(Number); return { h, m };
    }

    function isOpenNow(horarios) {
      // Mapa JS: 0=dom,1=seg,...
      const mapa = ['dom', 'seg', 'ter', 'qua', 'qui', 'sex', 'sab'];
      const now = new Date();
      const dia = mapa[now.getDay()];
      const faixa = horarios?.[dia];
      if (!faixa) return { open: false };
      const [ini, fim] = faixa.split('-');
      const { h: hi, m: mi } = parseHM(ini);
      const { h: hf, m: mf } = parseHM(fim);
      const t = now.getHours() * 60 + now.getMinutes();
      const a = hi * 60 + mi; const b = hf * 60 + mf;
      // suporta virada de dia (ex.: 18:00-00:30)
      let open = false;
      if (b >= a) open = (t >= a && t <= b); else open = (t >= a || t <= b);
      return { open, faixa };
    }

    function calcularTotais(carrinho, taxaEntrega = 0) {
      const subtotal = carrinho.reduce((acc, item) => {
        const base = item.preco * item.qtd;
        const add = (item.adicionais || []).reduce((a, ad) => a + ad.preco, 0) * item.qtd;
        return acc + base + add;
      }, 0);
      const total = subtotal + (taxaEntrega || 0);
      return { subtotal, total };
    }

    function montarTextoPedido(est, carrinho, dados) {
      const agora = new Date();
      const yy = String(agora.getFullYear()).slice(2);
      const mm = String(agora.getMonth() + 1).padStart(2, "0");
      const dd = String(agora.getDate()).padStart(2, "0");
      const HH = String(agora.getHours()).padStart(2, "0");
      const MM = String(agora.getMinutes()).padStart(2, "0");
      const idLinha = `Pedido: ${yy}${mm}${dd} - ${HH}:${MM}`;

      const taxaEntrega = (dados.tipo === 'Entrega') ? (est.taxasEntrega?.[dados.bairroEntrega] || 0) : 0;
      const { subtotal, total } = calcularTotais(carrinho, taxaEntrega);

      // itens: nome em negrito, descrição abaixo, extras/obs; linha em branco ENTRE itens
      const itensTxt = carrinho.map(it => {
        const adds = (it.adicionais || []).map(a => `+${a.nome}`).join(', ');
        const obs = it.obs ? ` [${it.obs}]` : '';
        const linha1 = `• ${it.qtd}x *${it.nome}* (${money(it.preco)})`;
        const linha2 = it.desc ? `   - ${it.desc}` : null;
        const linha3 = adds ? `   - ${adds}` : null;
        const linha4 = obs ? `   -${obs}` : null;
        return [linha1, linha2, linha3, linha4].filter(Boolean).join('\n');
      }).join('\n\n'); // << linha em branco entre cada item

      // 1) Dados do cliente
      const linhasCliente = [];
      linhasCliente.push(idLinha);
      linhasCliente.push('');
      linhasCliente.push(`Cliente: ${dados.nome || '-'}`);
      linhasCliente.push(`Tel: ${dados.telefone || '-'}`);
      if (MESA) linhasCliente.push(`Mesa: ${MESA}`);
      linhasCliente.push(`Tipo: ${dados.tipo}`);
      if (dados.tipo === 'Entrega') {
        linhasCliente.push(`Bairro: ${dados.bairroEntrega}`);
        linhasCliente.push(`Endereço: ${dados.endereco}${dados.numero ? ', ' + dados.numero : ''}${dados.referencia ? ` (${dados.referencia})` : ''}`);
      } else {
        linhasCliente.push('Retirada no balcão');
      }

      // 2) Informações do pedido (linha vazia após o título)
      const linhasPedido = ['Itens do Pedido:', '', itensTxt];

      // 3) Valores
      const linhasValores = ['Valores do Pedido:', `Subtotal: ${money(subtotal)}`];
      if (taxaEntrega) linhasValores.push(`Taxa (${dados.bairroEntrega}): ${money(taxaEntrega)}`);
      linhasValores.push(`Total: ${money(total)}`);
      linhasValores.push(`Pagamento: ${dados.pagamento || '-'}`);
      if (dados.obsGeral) linhasValores.push(`Obs: ${dados.obsGeral}`);

      const partes = [
        linhasCliente.join('\n'),
        linhasPedido.join('\n'),
        linhasValores.join('\n'),
        `Origem: Ola Carlopolis`
      ];

      return partes.join('\n\n'); // linhas em branco entre as seções
    }



    function enviarPedido(est, carrinho, dados) {
      if (!carrinho?.length) { alert('Seu carrinho está vazio.'); return; }
      if (dados.tipo === 'Entrega' && est.pedidoMinimo?.Entrega) {
        const { subtotal } = calcularTotais(carrinho, 0);
        if (subtotal < est.pedidoMinimo.Entrega) {
          alert(`Pedido mínimo para entrega: ${money(est.pedidoMinimo.Entrega)}`);
          return;
        }
      }
      const texto = montarTextoPedido(est, carrinho, dados);
      const urlEst = `https://wa.me/${normalizePhone(WHATS_ESTAB_FIXO)}?text=${encodeURIComponent(texto)}`;
      window.open(urlEst, '_blank');


    }

    /*******************
     * ESTADO & RENDER *
     *******************/
    const state = {
      est: EST,
      carrinho: [],
      selecionado: null,
    };

    function renderEst() {
      document.getElementById('est-name').textContent = state.est.nome;
      const logoEl = document.getElementById('est-logo'); 
      if (logoEl) 
      { logoEl.src = getLogo(state.est);
         logoEl.alt = `Logo de ${state.est.nome}`; }
      document.getElementById('est-desc').textContent = state.est.descricao || '';

      // Status aberto/fechado
      const st = isOpenNow(state.est.horarios);
      const badge = document.getElementById('openBadge');
      if (st.open) {
        badge.textContent = `Aberto agora • ${st.faixa}`;
        badge.className = 'oc-badge ok';
      } else {
        badge.textContent = st.faixa ? `Fechado • Hoje: ${st.faixa}` : 'Fechado hoje';
        badge.className = 'oc-badge danger';
      }

      // Bairros
      const bairroSel = document.getElementById('bairroSelect');
      bairroSel.innerHTML = '';
      const opt0 = document.createElement('option');
      opt0.value = ''; opt0.textContent = 'Selecione o bairro';
      bairroSel.appendChild(opt0);
      Object.keys(state.est.taxasEntrega || {}).forEach(b => {
        const op = document.createElement('option');
        op.value = b; op.textContent = `${b} (${money(state.est.taxasEntrega[b])})`;
        bairroSel.appendChild(op);
      });

      renderProdutos();
      renderCart();
      applyTipo();
      const pixInput = document.getElementById('pixChaveInput'); if (pixInput) { pixInput.value = PIX_CONFIG.chave; }
    }

    function renderProdutos() {
      const list = document.getElementById('prodList');
      list.innerHTML = '';
      state.est.cardapio.forEach((p) => {
        const wrap = document.createElement('div');
        wrap.className = 'oc-prod';
        wrap.innerHTML = `
          <div>
            <h4>${p.nome}</h4>
            <p>${p.desc || ''}</p>
          </div>
          <div class="oc-price">${money(p.preco)}</div>
        `;
        wrap.setAttribute('role','button'); wrap.tabIndex = 0;
        wrap.addEventListener('click', () => openItemModal(p));
        wrap.addEventListener('keydown', (ev)=>{ if (ev.key==='Enter' || ev.key===' '){ ev.preventDefault(); openItemModal(p);} });
        list.appendChild(wrap);
      });
    }

    function renderCart() {
      const box = document.getElementById('cartContainer');
      if (!state.carrinho.length) { box.className = 'oc-cart-empty'; box.textContent = 'Seu carrinho está vazio.'; updateTotals(); return; }
      box.className = '';
      box.innerHTML = '';
      state.carrinho.forEach((it, idx) => {
        const line = document.createElement('div');
        line.className = 'oc-cart-line';
        const adds = (it.adicionais || []).map(a => `+${a.nome}`).join(', ');
        const obs = it.obs ? ` • ${it.obs}` : '';
        line.innerHTML = `
          <div class="oc-qty">
            <button aria-label="diminuir">−</button>
            <span>${it.qtd}</span>
            <button aria-label="aumentar">+</button>
          </div>
          <div>
            <div class="oc-item-name"><strong>${it.nome}</strong></div>
            ${it.desc ? `<div class="oc-item-desc">${it.desc}</div>` : ''}
            <div class="oc-mini oc-muted">${adds}${obs}</div>
          </div>
          <div><strong>${money((it.preco + (it.adicionais || []).reduce((a, x) => a + x.preco, 0)) * it.qtd)}</strong></div>
        `;
        const [btnMenos, , btnMais] = line.querySelectorAll('.oc-qty button');
        btnMenos.addEventListener('click', () => { it.qtd = Math.max(1, it.qtd - 1); renderCart(); });
        btnMais.addEventListener('click', () => { it.qtd++; renderCart(); });
        // clique no nome para remover
        line.querySelector('div:nth-child(2) > div strong').addEventListener('contextmenu', (e) => {
          e.preventDefault(); if (confirm('Remover item?')) { state.carrinho.splice(idx, 1); renderCart(); }
        });
        box.appendChild(line);
      });
      updateTotals();
    }

    function updateTotals() {
      const tipo = document.getElementById('tipoPedido').value;
      const bairro = document.getElementById('bairroSelect').value;
      const taxa = (tipo === 'Entrega') ? (state.est.taxasEntrega?.[bairro] || 0) : 0;
      const { subtotal, total } = calcularTotais(state.carrinho, taxa);

      const minimoMsg = document.getElementById('minimoMsg');
      minimoMsg.textContent = '';

      const box = document.getElementById('totalsBox');
      box.innerHTML = `
        <div><span>Subtotal</span><span>${money(subtotal)}</span></div>
        ${tipo === 'Entrega' ? `<div><span>Taxa (${bairro || '-'})</span><span>${money(taxa)}</span></div>` : ''}
        <div class="oc-total"><span>Total</span><span>${money(total)}</span></div>
      `;

      const st = isOpenNow(state.est.horarios);
      const btn = document.getElementById('btnEnviar');
      btn.disabled = !state.carrinho.length || !st.open || (tipo === 'Entrega' && !bairro);
      btn.textContent = st.open ? 'Enviar pedido pelo WhatsApp' : 'Fechado agora';
    }

    function applyTipo() {
      const tipo = document.getElementById('tipoPedido').value;
      const endWrap = document.getElementById('enderecoFields');
      const bairroSel = document.getElementById('bairroSelect');
      if (tipo === 'Entrega') {
        endWrap.style.display = 'grid';
        bairroSel.disabled = false;
      } else {
        endWrap.style.display = 'none';
        bairroSel.disabled = true; bairroSel.value = '';
      }
      updateTotals();
    }

    // Modal item
    let modalItem = null;
    function openItemModal(p) {
      modalItem = JSON.parse(JSON.stringify(p));
      modalItem.qtd = 1; modalItem._addsSel = new Set();
      document.getElementById('mNome').textContent = p.nome;
      document.getElementById('mDesc').textContent = p.desc || '';
      const mImg = document.getElementById('mImg'); if (mImg) { mImg.src = (typeof getFoto==='function' ? getFoto(p) : (p.foto||'')); mImg.alt = `Foto de ${p.nome}`; }
      document.getElementById('mObs').value = '';
      document.getElementById('mQtd').textContent = '1';
      renderAdds(p);
      updateModalSubtotal();
      document.getElementById('itemModal').showModal();
    }

    function renderAdds(p) {
      const box = document.getElementById('mAdds');
      box.innerHTML = '';
      (p.adicionais || []).forEach(ad => {
        const span = document.createElement('label');
        span.className = 'oc-chip';
        span.innerHTML = `<input type="checkbox" data-id="${ad.id}" /> ${ad.nome} (+${money(ad.preco)})`;
        span.querySelector('input').addEventListener('change', (e) => {
          if (e.target.checked) modalItem._addsSel.add(ad.id); else modalItem._addsSel.delete(ad.id);
          updateModalSubtotal();
        });
        box.appendChild(span);
      });
      if (!p.adicionais || !p.adicionais.length) {
        box.innerHTML = '<span class="oc-muted">Sem adicionais para este item.</span>';
      }
    }

    function updateModalSubtotal() {
      const qtd = Number(document.getElementById('mQtd').textContent) || 1;
      const addsPreco = (modalItem.adicionais || []).filter(a => modalItem._addsSel.has(a.id)).reduce((s, a) => s + a.preco, 0);
      const val = (modalItem.preco + addsPreco) * qtd;
      document.getElementById('mSubtotal').textContent = money(val);
    }

    document.getElementById('mMais').addEventListener('click', () => { const el = document.getElementById('mQtd'); el.textContent = String(Number(el.textContent) + 1); updateModalSubtotal(); });
    document.getElementById('mMenos').addEventListener('click', () => { const el = document.getElementById('mQtd'); el.textContent = String(Math.max(1, Number(el.textContent) - 1)); updateModalSubtotal(); });
    document.getElementById('mAddBtn').addEventListener('click', () => {
      const qtd = Number(document.getElementById('mQtd').textContent) || 1;
      const obs = document.getElementById('mObs').value.trim();
      const adds = (modalItem.adicionais || []).filter(a => modalItem._addsSel.has(a.id));
      state.carrinho.push({ id: modalItem.id, nome: modalItem.nome, preco: modalItem.preco, qtd, adicionais: adds, obs });
      document.getElementById('itemModal').close();
      renderCart();
    });

    // Eventos principais
    document.getElementById('tipoPedido').addEventListener('change', applyTipo);
    document.getElementById('bairroSelect').addEventListener('change', updateTotals);
    document.getElementById('btnEnviar').addEventListener('click', () => {
      const dados = {
        tipo: document.getElementById('tipoPedido').value,
        bairroEntrega: document.getElementById('bairroSelect').value || null,
        endereco: document.getElementById('endereco').value,
        numero: document.getElementById('numeroEndereco').value,
        referencia: document.getElementById('referencia').value,
        nome: document.getElementById('cliNome').value,
        telefone: document.getElementById('cliFone').value,
        pagamento: document.getElementById('pagamento').value,
        obsGeral: document.getElementById('obsGeral').value
      };
      enviarPedido(state.est, state.carrinho, dados);
    });

    // Boot
    renderEst();

    // Gera PIX (copia e cola) com o valor total
    document.getElementById('btnPix').addEventListener('click', () => {
      const tipo = document.getElementById('tipoPedido').value;
      const bairro = document.getElementById('bairroSelect').value;
      const taxa = (tipo === 'Entrega') ? (state.est.taxasEntrega?.[bairro] || 0) : 0;
      const { total } = calcularTotais(state.carrinho, taxa);
      openPixModal(total);
    });
    function openFotoModal(p) {
      const modal = document.getElementById('fotoModal');
      document.getElementById('fotoTitulo').textContent = p.nome;
      const img = document.getElementById('fotoImg');
      img.src = (typeof getFoto === 'function') ? getFoto(p) : (p.foto || '');
      img.alt = `Foto de ${p.nome}`;
      modal.showModal();
    }

    function emv(tag, value) {
      const len = String(value.length).padStart(2, '0');
      return tag + len + value;
    }
    function crc16(str) {
      let crc = 0xFFFF;
      for (let i = 0; i < str.length; i++) {
        crc ^= str.charCodeAt(i) << 8;
        for (let j = 0; j < 8; j++) {
          if (crc & 0x8000) crc = (crc << 1) ^ 0x1021;
          else crc = crc << 1;
          crc &= 0xFFFF;
        }
      }
      return crc.toString(16).toUpperCase().padStart(4, '0');
    }
    function buildPixCopiaCola({ valor, txid = 'TXID', chavePix = null }) {
      const chave = (chavePix ?? PIX_CONFIG.chave);
      const gui = emv('00', 'br.gov.bcb.pix');
      const key = emv('01', chave);
      const merAcc = emv('26', gui + key);
      const mcc = emv('52', '0000');
      const moeda = emv('53', '986'); // BRL
      const valorStr = Number(valor).toFixed(2);
      const val = emv('54', valorStr);
      const pais = emv('58', 'BR');
      const nome = emv('59', PIX_CONFIG.nome);
      const cidade = emv('60', PIX_CONFIG.cidade);
      const txidField = emv('05', String(txid).slice(0, 25));
      const add = emv('62', txidField);
      let payload = '000201' + merAcc + mcc + moeda + val + pais + nome + cidade + add;
      payload += '6304';
      const checksum = crc16(payload);
      return payload + checksum;
    }
    function openPixModal(total) {
      const modal = document.getElementById('pixModal');
      const chaveUi = document.getElementById('pixChaveInput');
      const chave = (chaveUi && chaveUi.value.trim()) ? chaveUi.value.trim() : PIX_CONFIG.chave;
      document.getElementById('pixChaveShow').value = chave;
      const now = new Date();
      const txid = (PIX_CONFIG.txidPrefix || 'OC') + '-' + now.getFullYear().toString().slice(2) + String(now.getMonth() + 1).padStart(2, '0') + String(now.getDate()).padStart(2, '0') + '-' + String(now.getHours()).padStart(2, '0') + String(now.getMinutes()).padStart(2, '0');
      const code = buildPixCopiaCola({ valor: total, txid, chavePix: chave });
      document.getElementById('pixCopiaCola').value = code;
      modal.showModal();
    }
    function copyTextById(id) {
      const el = document.getElementById(id);
      el.select();
      document.execCommand('copy');
    }
    document.addEventListener('click', (e) => {
      if (e.target && e.target.id === 'btnCopyPix') { copyTextById('pixChaveInput'); }
      else if (e.target && e.target.id === 'btnCopyPix2') { copyTextById('pixChaveShow'); }
      else if (e.target && e.target.id === 'btnCopyCopiaCola') { copyTextById('pixCopiaCola'); }
    });
  </script>
<dialog class="oc-modal" id="pixModal">
<header>
<strong>Pagamento via PIX</strong>
<button class="oc-btn-sec" onclick="document.getElementById('pixModal').close()">Fechar</button>
</header>
<div class="oc-content">
<div class="oc-field">
<label>Chave PIX</label>
<div class="oc-row" style="gap:8px;">
<input id="pixChaveShow" readonly="" type="text"/>
<button class="oc-btn-sec" id="btnCopyPix2">Copiar</button>
</div>
</div>
<div class="oc-field">
<label>Código PIX (copia e cola) – valor total</label>
<textarea id="pixCopiaCola" readonly="" rows="4"></textarea>
<div class="oc-row" style="justify-content:flex-end; margin-top:8px;">
<button class="oc-btn-pri" id="btnCopyCopiaCola">Copiar código</button>
</div>
<div class="oc-mini oc-muted">Cole este código no seu banco para pagar. O valor já vem preenchido.</div>
</div>
</div>
</dialog>
<dialog class="oc-modal" id="fotoModal">
<header>
<strong id="fotoTitulo">Foto</strong>
<button class="oc-btn-sec" onclick="document.getElementById('fotoModal').close()">Fechar</button>
</header>
<div class="oc-content" style="text-align:center">
<img alt="Foto do item" id="fotoImg" style="max-width:100%; border-radius:12px; border:1px solid var(--oc-border, rgba(0,0,0,0.08));"/>
</div>
</dialog>
</body>
</html>