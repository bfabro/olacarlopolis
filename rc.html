<!-- Salve como relatorio.html -->
<!DOCTYPE html>
<html lang="pt-BR">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Relat√≥rio - Acessos</title>
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
	<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
	<style>
		body {
			font-family: 'Segoe UI', sans-serif;
			background-color: #121212;
			color: #f5f5f5;
			margin: 0;
			padding: 20px;
			overflow-y: auto;
			/* ‚úÖ Isso ativa a rolagem */
		}

		.container {
			margin: 0 auto;
			display: block;
			width: 344px;
			background-color: #1e1e1e;
			padding: 14px;
			border-radius: 12px;
			box-shadow: 0 0 15px rgba(0, 0, 0, 0.4);
		}

		h1 {
			text-align: center;
			color: #00bcd4;
			margin-bottom: 20px;
			font-size: 24px;
		}

		.section-title {
			color: #00bcd4;
			font-size: 18px;
			margin: 1px 0 10px;
			display: flex;
			align-items: center;
			gap: 6px;
			justify-content: center;
			/* <-- centraliza o conte√∫do */
			text-align: center;
			/* <-- para garantir */
			width: 100%;
			/* <-- pega largura total do card */
		}

		.filtros {
			display: flex;
			flex-direction: column;
			gap: 10px;
			margin-bottom: 20px;
		}

		label {
			font-weight: bold;
		}

		select,
		input[type="date"],
		input[type="month"],
		button {
			padding: 10px;
			background-color: #2a2a2a;
			color: #fff;
			border: 1px solid #444;
			border-radius: 6px;
			font-size: 14px;
		}

		button {
			background: linear-gradient(135deg, #00bcd4, #007b8a);
			color: #ffffff;
			font-weight: bold;
			padding: 10px 15px;
			border: none;
			border-radius: 8px;
			cursor: pointer;
			transition: all 0.3s ease;
			box-shadow: 0 2px 8px rgba(0, 188, 212, 0.4);
		}

		button:hover {
			background: linear-gradient(135deg, #00a3ba, #006273);
			transform: scale(1.03);
			box-shadow: 0 4px 12px rgba(0, 188, 212, 0.6);
		}

		.card {
			background-color: #2a2a2a;
			border-radius: 10px;
			padding: 6px;
			margin-bottom: 20px;
			box-shadow: 0 0 10px rgba(0, 0, 0, 0.2);
		}

		table {
			width: 100%;
			border-collapse: collapse;
			background-color: #1e1e1e;
			font-size: 14px;
			margin-bottom: 20px;
		}

		th,
		td {
			padding: 8px;
			text-align: left;
			border-bottom: 1px solid #333;
		}

		th {
			background-color: #222;
			color: #00bcd4;
			font-size: 15px;
			padding: 8px;
		}

		tr:hover {
			background-color: #2a2a2a;
		}

		.hidden {
			display: none;
		}

		th:nth-child(2),
		td:nth-child(2) {
			text-align: center;
		}

		.info-box p {
			margin: 5px 0;
		}

		td {
			font-size: 15px;
			padding: 8px;
		}

		#btnExportar {
			background: linear-gradient(135deg, #ff9800, #ff5722);
			/* Laranja para contraste */
			color: #fff;
			font-weight: bold;
			padding: 6px 12px;
			border: none;
			border-radius: 6px;
			font-size: 12px;
			cursor: pointer;
			transition: all 0.3s ease;
			box-shadow: 0 2px 8px rgba(255, 152, 0, 0.4);
		}

		#btnExportar:hover {
			background: linear-gradient(135deg, #f57c00, #e64a19);
			transform: scale(1.05);
			box-shadow: 0 4px 12px rgba(255, 152, 0, 0.6);
		}

		#btnBuscar {
			font-size: 20px;
		}

		#btnExportarExcel {
			background: linear-gradient(135deg, #4caf50, #2e7d32);
			/* Verde suave */
			color: #fff;
			font-weight: bold;
			border: none;
			border-radius: 6px;
			font-size: 12px;
			cursor: pointer;
			transition: all 0.3s ease;
			box-shadow: 0 2px 8px rgba(76, 175, 80, 0.4);
		}

		#btnExportarExcel:hover {
			background: linear-gradient(135deg, #388e3c, #1b5e20);
			transform: scale(1.05);
			box-shadow: 0 4px 12px rgba(76, 175, 80, 0.6);
		}


		#dataRelatorio {
			font-size: 16px;
			font-weight: bold;
			color: #00bcd4;
			margin-bottom: 12px;
			text-align: center;
		}

		.card table {
			min-height: 50px;
		}


		/* Loader global */
		.loader-overlay {
			position: fixed;
			inset: 0;
			display: none;
			place-items: center;
			background: rgba(0, 0, 0, .55);
			z-index: 20000;
		}

		.loader-box {
			display: flex;
			flex-direction: column;
			align-items: center;
			gap: 10px;
		}

		.loader {
			width: 54px;
			height: 54px;
			border: 6px solid #2a2a2a;
			border-top-color: #00bcd4;
			border-radius: 50%;
			animation: spin .9s linear infinite;
		}

		@keyframes spin {
			to {
				transform: rotate(360deg)
			}
		}

		.loader-text {
			color: #00bcd4;
			font-weight: 600;
			font-size: 14px;
		}


		button.loading {
			background: linear-gradient(135deg, #e53935, #b71c1c) !important;
			box-shadow: 0 2px 8px rgba(229, 57, 53, 0.6) !important;
		}
	</style>
</head>

<body>
	<div class="container">
		<h1>Relat√≥rio Ola Carlopolis</h1>
		<div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
			<h2 style="margin:0; font-size: 18px; color:#00bcd4;">üìä Relat√≥rio de Cliques</h2>
			<div>
				<button id="btnExportarExcel"
					style="padding: 6px 12px; font-size: 12px; margin-left: 6px;">Excel</button>
				<button id="btnExportar" style="padding: 6px 12px; font-size: 12px;">PDF</button>

			</div>


		</div>
		<div class="filtros card">
			<label for="tipoRelatorio">Tipo de Relat√≥rio:</label>
			<select id="tipoRelatorio">
				<option value="diario">Di√°rio</option>
				<option value="semanal">Semanal</option>
				<option value="mensal">Mensal</option>
			</select>
			<input type="date" id="filtroData" class="filtro">
			<input type="month" id="filtroMes" class="filtro hidden">
			<select id="filtroSemana" class="filtro hidden">
				<option value="1">Semana 1 (1‚Äì7)</option>
				<option value="2">Semana 2 (8‚Äì14)</option>
				<option value="3">Semana 3 (15‚Äì21)</option>
				<option value="4">Semana 4 (22‚Äì28)</option>
				<option value="5">Semana 5 (29‚Äì31)</option>
			</select>
			<button id="btnBuscar">Buscar</button>

		</div>




		<p id="dataRelatorio">üìÖ Data do Relat√≥rio: -</p>

		<div class="card">
			<h2 class="section-title">üìà Resumo de Acessos</h2>
			<table>
				<thead>
					<tr>
						<th>Descri√ß√£o</th>
						<th>Total</th>
					</tr>
				</thead>
				<tbody>
					<tr>
						<td><strong>Usu√°rios √önicos</strong></td>
						<td id="usuariosUnicos">-</td>
					</tr>
					<tr>
						<td><strong>Total de Acessos</strong></td>
						<td id="totalAcessos">-</td>
					</tr>

				</tbody>
			</table>
		</div>

		<!-- NOVO CARD - Origem dos Acessos -->
		<div class="card">
			<h2 class="section-title">üîó Origem dos Acessos</h2>
			<table>
				<thead>
					<tr>
						<th>Origem</th>
						<th>Acessos</th>
					</tr>
				</thead>
				<tbody id="tabelaOrigem"></tbody>
			</table>
		</div>

		<div class="card">
			<h2 class="section-title">üìÇ Cliques por Categoria</h2>
			<table>
				<thead>
					<tr>
						<th>Categoria</th>
						<th>Cliques</th>
					</tr>
				</thead>
				<tbody id="tabelaResultados"></tbody>
			</table>
		</div>

		<div class="card">
			<h2 class="section-title">üñ± Cliques Bot√µes Estabelecimentos</h2>
			<table>
				<thead>
					<tr>
						<th>Estabelecimento</th>
						<!-- <th>Divulga√ß√£o</th> -->
						<th>Fotos</th>
						<th>Card√°pio</th>
						<th>Telefone</th> <!-- NOVO -->

					</tr>
				</thead>
				<tbody id="tabelaBotoes">
					<tr>
						<td colspan="4" style="text-align:center; color: #999;">Nenhum dado carregado ainda</td>
					</tr>
				</tbody>
			</table>
		</div>




		<!-- Adicione aqui os outros cards de relat√≥rio existentes -->









		<div class="card">
			<h2 class="section-title">Onde Comer</h2>
			<table>
				<thead>
					<tr>
						<th>Estabelecimento</th>
						<th>Card√°pio</th>
						<th>WhatsApp</th>
					</tr>
				</thead>
				<tbody id="tabelaOndeComerCardapio">
					<tr>
						<td colspan="3" style="text-align:center; color: #999;">Carregando...</td>
					</tr>
				</tbody>
			</table>
		</div>


		<div class="card" id="cardPromocoesClicadas" style="display: none;">
			<h2 class="section-title">üî• Promo√ß√µes Acessadas</h2>
			<table>
				<thead>
					<tr>
						<th>Estabelecimento</th>
						<th style="text-align: center;">Total de Cliques</th>
					</tr>
				</thead>
				<tbody id="tabelaPromocoes"></tbody>
			</table>
		</div>

		<!-- üì≤ Cliques ‚Äì Grupos de WhatsApp -->
		<div class="card" style="margin-top:14px;">
			<h3 style="margin:0 0 8px;">üì≤ Cliques ‚Äì Grupos de WhatsApp</h3>
			<table style="width:100%; border-collapse: collapse;">
				<thead>
					<tr>
						<th style="text-align:left;">Grupo (id)</th>
						<th style="text-align:center;">Entrar no grupo</th>
					</tr>
				</thead>
				<tbody id="tabelaGruposWhats">
					<tr>
						<td colspan="2" style="text-align:center; color:#999;">Carregando...</td>
					</tr>
				</tbody>
			</table>
		</div>

		<div class="card">
			<h2 class="section-title">üè† Cliques de Im√≥veis</h2>
			<table>
				<thead>
					<tr>
						 <th>Im√≥vel</th>
    <th>Propriet√°rio</th>
    <th>Corretor</th>
    <th style="text-align:center">WhatsApp</th>
    <th style="text-align:center">Fotos</th>
					</tr>
				</thead>
				<tbody id="tabelaCliquesImoveis">
					<tr>
						<td colspan="3" style="text-align:center; color:#999;">Carregando...</td>
					</tr>
				</tbody>
			</table>
		</div>


		<div class="card">
			<h2 class="section-title">üìá Contatos de Im√≥veis (WhatsApp)</h2>
			<table>
				<thead>
					<tr>
						<th>Data/Hora</th>
						<th>Im√≥vel</th>
						<th>Nome Cliente</th>
						<th>Tel Responsavel</th>
						<th>Responsavel</th> <!-- NOVO -->
					</tr>
				</thead>
				<tbody id="tabelaContatosImoveis">
					<tr>
						<td colspan="4" style="text-align:center; color:#999;">Carregando...</td>
					</tr>
				</tbody>
			</table>
		</div>





		<div class="card">
			<h2 class="section-title">üì≤ Instala√ß√µes do App (PWA)</h2>
			<table>
				<thead>
					<tr>
						<th>Data</th>
						<th>Instala√ß√µes</th>
					</tr>
				</thead>
				<tbody id="tabelaInstalacoesPWA">
					<tr>
						<td colspan="2" style="text-align:center;">Nenhum dado ainda</td>
					</tr>
				</tbody>
			</table>
		</div>

		<div class="card">
			<h2 class="section-title">üì± Uso Di√°rio do App Instalado (PWA)</h2>
			<table>
				<thead>
					<tr>
						<th>Data</th>
						<th>Usos</th>
						<th>Conex√µes</th>
					</tr>
				</thead>
				<tbody id="tabelaUsoPWA">

					<tr>
						<td colspan="2" style="text-align:center;">Nenhum dado ainda</td>
					</tr>
				</tbody>
			</table>
		</div>

		<div class="card">
			<h2 class="section-title">üïí Acessos por Faixa de Hor√°rio</h2>
			<table>
				<thead>
					<tr>
						<th>Faixa</th>
						<th>Acessos</th>
					</tr>
				</thead>
				<tbody id="tabelaHorarios"></tbody>
			</table>
		</div>

		<div class="card">
			<h2 class="section-title">üåç Resumo por Cidade</h2>
			<table>
				<thead>
					<tr>
						<th>Cidade</th>
						<th>Acessos</th>
					</tr>
				</thead>
				<tbody id="tabelaCidades"></tbody>
			</table>
		</div>

		<!-- Firebase -->
		<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
		<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>


		<script>
			const firebaseConfig = {
				apiKey: "AIzaSyDWHsZSHwVFpD88ChUywjw_GdZPifdrRGI",
				authDomain: "contadoracessos.firebaseapp.com",
				databaseURL: "https://contadoracessos-default-rtdb.firebaseio.com",
				projectId: "contadoracessos",
				storageBucket: "contadoracessos.appspot.com",
				messagingSenderId: "521517291315",
				appId: "1:521517291315:web:74f8d878d2d8769460d046"
			};
			firebase.initializeApp(firebaseConfig);
			const db = firebase.database();
		</script>

		<script>
			const overlayEl = document.getElementById('loadingOverlay');
			let loadCount = 0;

			function startLoading() {
				loadCount++;
				if (overlayEl) overlayEl.style.display = 'grid';
				const btn = document.getElementById('btnBuscar');
				if (btn) {
					if (!btn.dataset.originalText) btn.dataset.originalText = btn.innerHTML;
					btn.innerHTML = 'Buscando‚Ä¶';
					btn.setAttribute('disabled', 'disabled');
					btn.classList.add('loading');   // üî¥ deixa vermelho
				}
			}

			function stopLoading() {
				loadCount = Math.max(0, loadCount - 1);
				if (loadCount === 0) {
					if (overlayEl) overlayEl.style.display = 'none';
					const btn = document.getElementById('btnBuscar');
					if (btn) {
						btn.removeAttribute('disabled');
						if (btn.dataset.originalText) btn.innerHTML = btn.dataset.originalText;
						btn.classList.remove('loading'); // üîµ volta para azul
					}
				}
			}

		</script>


		<script>
			const tipoRelatorioEl = document.getElementById("tipoRelatorio");
			tipoRelatorioEl.addEventListener("change", e => {
				document.querySelectorAll(".filtro").forEach(f => f.classList.add("hidden"));
				if (e.target.value === "diario") {
					document.getElementById("filtroData").classList.remove("hidden");
				} else if (e.target.value === "mensal") {
					document.getElementById("filtroMes").classList.remove("hidden");
				} else {
					document.getElementById("filtroMes").classList.remove("hidden");
					document.getElementById("filtroSemana").classList.remove("hidden");
				}
			});

			let valoresAnteriores = JSON.parse(localStorage.getItem("valoresAnterioresCliques") || "{}");
			let cidadesAnteriores = JSON.parse(localStorage.getItem("valoresAnterioresCidades") || "{}");


			document.getElementById("btnBuscar").addEventListener("click", async () => {
				startLoading();                // üî¥ fica vermelho + overlay
				try {



					const tipo = tipoRelatorioEl.value;
					const resultados = {};
					const unicos = new Set();

					const snapCliques = await db.ref("cliquesPorMenu").once("value");
					const snapUsuarios = await db.ref("usuariosUnicos").once("value");
					const snapAcessos = await db.ref("acessosPorDia").once("value");

					const snapBotoes = await db.ref("cliquesPorBotao").once("value");

					const snapPWA = await db.ref("instalacoesPWA").once("value");
					const dadosPWA = snapPWA.val() || {};

					const dadosBotoes = snapBotoes.val() || {};

					const dadosCliques = snapCliques.val() || {};
					const dadosUsuarios = snapUsuarios.val() || {};
					const dadosAcessos = snapAcessos.val() || {};





					let diasFiltrados = [];

					const getDiaNum = d => parseInt(d.split("-")[2]);





					if (tipo === "diario") {
						const dia = document.getElementById("filtroData").value;
						diasFiltrados = [dia];

					} else if (tipo === "mensal") {
						const mes = document.getElementById("filtroMes").value;
						const diasDoMes = new Set([
							...Object.keys(dadosCliques).filter(dia => dia.startsWith(mes)),
							...Object.keys(dadosBotoes).filter(dia => dia.startsWith(mes))
						]);
						diasFiltrados = Array.from(diasDoMes);
					} else if (tipo === "semanal") {
						const mesSelecionado = document.getElementById("filtroMes").value;
						const semanaSelecionada = parseInt(document.getElementById("filtroSemana").value);

						if (!mesSelecionado || isNaN(semanaSelecionada)) {
							alert("Selecione um m√™s e uma semana para o relat√≥rio semanal.");
							return;
						}

						const inicio = (semanaSelecionada - 1) * 7 + 1;
						const fim = semanaSelecionada * 7;

						const diasDaSemana = new Set([
							...Object.keys(dadosCliques).filter(dia =>
								dia.startsWith(mesSelecionado) && getDiaNum(dia) >= inicio && getDiaNum(dia) <= fim
							),
							...Object.keys(dadosBotoes).filter(dia =>
								dia.startsWith(mesSelecionado) && getDiaNum(dia) >= inicio && getDiaNum(dia) <= fim
							)
						]);

						diasFiltrados = Array.from(diasDaSemana);


					}


					if (diasFiltrados.length === 0 || !diasFiltrados[0]) {
						alert("Nenhuma data selecionada ou nenhum dado encontrado.");
						return;
					}


					let totalAcessos = 0;

					diasFiltrados.forEach(dia => {
						const categorias = dadosCliques[dia] || {};
						Object.entries(categorias).forEach(([nome, info]) => {
							if (!resultados[nome]) resultados[nome] = 0;
							resultados[nome] += info.total || 0;
						});

						if (dadosUsuarios[dia]) {
							Object.keys(dadosUsuarios[dia]).forEach(ip => unicos.add(ip));
						}

						const acessosDetalhados = dadosAcessos[dia]?.detalhados;
						if (acessosDetalhados) {
							totalAcessos += Object.keys(acessosDetalhados).length;
						}
					});


					// Tabela de Origem dos Acessos
					const origens = {};
					diasFiltrados.forEach(dia => {
						const acessosDia = dadosAcessos[dia]?.detalhados || {};
						Object.values(acessosDia).forEach(acesso => {
							const origem = acesso.origem || "acesso direto";
							if (!origens[origem]) origens[origem] = 0;
							origens[origem]++;
						});
					});

					const tabelaOrigem = document.getElementById("tabelaOrigem");
					tabelaOrigem.innerHTML = "";

					Object.entries(origens)
						.sort((a, b) => b[1] - a[1])
						.forEach(([origem, total]) => {
							const row = document.createElement("tr");
							row.innerHTML = `<td>${origem}</td><td style="text-align:center">${total}</td>`;
							tabelaOrigem.appendChild(row);
						});


					/// inicio contabilizar promo√ßoes

					const snapPromos = await db.ref("cliquesPromocoesPorComercio").once("value");
					const dadosPromos = snapPromos.val() || {};

					const tabelaPromocoes = document.getElementById("tabelaPromocoes");
					const cardPromocoes = document.getElementById("cardPromocoesClicadas");

					tabelaPromocoes.innerHTML = "";
					let totalPorComercio = {};

					diasFiltrados.forEach(dia => {
						const dadosDia = dadosPromos[dia] || {};
						Object.entries(dadosDia).forEach(([comercio, total]) => {
							totalPorComercio[comercio] = (totalPorComercio[comercio] || 0) + total;
						});
					});

					Object.entries(totalPorComercio)
						.sort((a, b) => b[1] - a[1])
						.forEach(([comercio, total]) => {
							const row = document.createElement("tr");
							row.innerHTML = `
      <td>${comercio}</td>
      <td style="text-align:center;">${total}</td>
    `;
							tabelaPromocoes.appendChild(row);
						});

					cardPromocoes.style.display = Object.keys(totalPorComercio).length ? "block" : "none";


					/// fim contabilizar promo√ßoes 

					const snapUsoPWA = await db.ref("usoPWA").once("value");
					const dadosUsoPWA = snapUsoPWA.val() || {};

					const tabelaUsoPWA = document.getElementById("tabelaUsoPWA");
					tabelaUsoPWA.innerHTML = "";

					let totalUsoPWA = 0;





					diasFiltrados.forEach(dia => {
						const registros = dadosUsoPWA[dia];
						const quantidade = registros ? Object.keys(registros).length : 0;
						totalUsoPWA += quantidade;

						// Contar tipos de conex√£o
						const contagemConexoes = {};
						if (registros) {
							Object.values(registros).forEach(reg => {
								const tipo = reg.conexao || "desconhecido";
								contagemConexoes[tipo] = (contagemConexoes[tipo] || 0) + 1;
							});
						}

						const listaConexoes = Object.entries(contagemConexoes)
							.map(([tipo, qtd]) => `${tipo}: ${qtd}`)
							.join("<br>");

						const row = document.createElement("tr");
						row.innerHTML = `
    <td>${dia}</td>
    <td style="text-align:center;">${quantidade}</td>
    <td style="text-align:center;">${listaConexoes}</td>
  `;
						tabelaUsoPWA.appendChild(row);
					});






					if (totalUsoPWA === 0) {
						tabelaUsoPWA.innerHTML = `<tr><td colspan="2" style="text-align:center; color:#999;">Nenhum uso registrado</td></tr>`;
					}


					document.getElementById("totalAcessos").textContent = totalAcessos;
					document.getElementById("usuariosUnicos").textContent = unicos.size;

					const tabela = document.getElementById("tabelaResultados");
					tabela.innerHTML = "";


					// Criar uma c√≥pia dos valores anteriores para comparar
					const anteriores = { ...valoresAnteriores };
					valoresAnteriores = {}; // Reset para regravar os novos ao final

					Object.entries(resultados)
						.sort((a, b) => b[1] - a[1])
						.forEach(([nome, total]) => {
							const nomeFormatado = nome.startsWith("menu") ? nome.replace("menu", "") : nome;

							// Oculta as categorias indesejadas
							const nomesOcultos = ["horizontal", "comercio", "eventos"];
							if (nomesOcultos.includes(nomeFormatado.toLowerCase())) return;

							const row = document.createElement("tr");
							row.innerHTML = `<td>${nomeFormatado}</td><td>${total}</td>`;

							// Destaque amarelo para novos ou alterados
							if (anteriores[nome] === undefined || anteriores[nome] !== total) {
								row.style.color = "yellow";
								row.style.fontWeight = "bold";
							}

							valoresAnteriores[nome] = total;
							tabela.appendChild(row);
						});

					localStorage.setItem("valoresAnterioresCliques", JSON.stringify(valoresAnteriores));




					// Mostrar data do relat√≥rio
					document.getElementById("dataRelatorio").textContent = `Data do Relat√≥rio: ${diasFiltrados.join(", ")}`;

					// Criar tabela de cidades
					const cidadesContagem = {};
					diasFiltrados.forEach(dia => {
						const acessosDia = dadosAcessos[dia]?.detalhados || {};
						Object.values(acessosDia).forEach(acesso => {
							const cidade = acesso.cidade || "Desconhecida";
							if (!cidadesContagem[cidade]) cidadesContagem[cidade] = 0;
							cidadesContagem[cidade]++;
						});
					});

					const tabelaCidades = document.getElementById("tabelaCidades");
					tabelaCidades.innerHTML = "";










					const tabelaInstalacoes = document.getElementById("tabelaInstalacoesPWA");
					tabelaInstalacoes.innerHTML = "";

					let totalInstalacoes = 0;

					diasFiltrados.forEach(dia => {
						const registros = dadosPWA[dia];
						const quantidade = registros ? Object.keys(registros).length : 0;
						totalInstalacoes += quantidade;

						const row = document.createElement("tr");
						row.innerHTML = `<td>${dia}</td><td style="text-align:center;">${quantidade}</td>`;
						tabelaInstalacoes.appendChild(row);
					});

					if (totalInstalacoes === 0) {
						tabelaInstalacoes.innerHTML = `<tr><td colspan="2" style="text-align:center; color:#999;">Nenhuma instala√ß√£o registrada</td></tr>`;
					}



					const cidadesAnterioresTemp = { ...cidadesAnteriores };
					cidadesAnteriores = {}; // Resetar antes de salvar os novos dados

					Object.entries(cidadesContagem)
						.sort((a, b) => b[1] - a[1])
						.forEach(([cidade, total]) => {
							const row = document.createElement("tr");
							row.innerHTML = `<td>${cidade}</td><td style="text-align:center">${total}</td>`;

							if (cidadesAnterioresTemp[cidade] === undefined) {
								// Nova cidade
								row.style.color = "yellow";
								row.style.fontWeight = "bold";
							} else if (cidadesAnterioresTemp[cidade] !== total) {
								// Cidade existente com valor alterado
								row.style.color = "yellow";
								row.style.fontWeight = "bold";
							}

							cidadesAnteriores[cidade] = total;
							tabelaCidades.appendChild(row);
						});

					localStorage.setItem("valoresAnterioresCidades", JSON.stringify(cidadesAnteriores));



					// Resumo por faixa de hor√°rio
					const horarios = {};

					diasFiltrados.forEach(dia => {
						const acessos = dadosAcessos[dia]?.detalhados || {};
						Object.values(acessos).forEach(acesso => {
							const horaCompleta = acesso.horario || "00:00:00";
							const hora = parseInt(horaCompleta.split(":")[0]);
							const faixa = `${hora}:00 ‚Äì ${hora + 1}:00`;

							if (!horarios[faixa]) horarios[faixa] = 0;
							horarios[faixa]++;
						});
					});

					const tabelaHorarios = document.getElementById("tabelaHorarios");
					tabelaHorarios.innerHTML = "";
					Object.entries(horarios)
						.sort((a, b) => {
							// Extrai o n√∫mero da hora inicial
							const horaA = parseInt(a[0].split(":")[0]);
							const horaB = parseInt(b[0].split(":")[0]);
							return horaA - horaB;
						})
						.forEach(([faixa, total]) => {
							const row = document.createElement("tr");
							row.innerHTML = `<td>${faixa}</td><td style="text-align:center">${total}</td>`;
							tabelaHorarios.appendChild(row);
						});







					const tabelaBotoes = document.getElementById("tabelaBotoes");
					tabelaBotoes.innerHTML = "";

					// Agrega por estabelecimento: fotos, cardapio, telefone
					const agregBotoes = {}; // { estId: { fotos:0, cardapio:0, telefone:0 } }

					for (const dia of diasFiltrados) {
						const porDia = dadosBotoes[dia] || {};
						for (const estId of Object.keys(porDia)) {
							const tipos = porDia[estId] || {};
							// depois:
							const f = Number(tipos.fotos || 0);
							const c = Number(tipos.cardapio || 0);
							const t = Number(tipos.telefone || 0);
							if (f || c || t) {
								if (!agregBotoes[estId]) agregBotoes[estId] = { fotos: 0, cardapio: 0, telefone: 0 };
								agregBotoes[estId].fotos += f;
								agregBotoes[estId].cardapio += c;
								agregBotoes[estId].telefone += t;
							}
						}
					}

					// comparar com valores anteriores para destaque
					let botoesAnteriores = JSON.parse(localStorage.getItem("valoresAnterioresBotoes") || "{}");
					const botoesAnterioresTemp = { ...botoesAnteriores };
					botoesAnteriores = {};

					const itensOrdenados = Object.entries(agregBotoes)
						.map(([estId, v]) => ({ estId, ...v }))
						.filter(it => (it.fotos + it.cardapio + it.telefone) > 0) // <-- filtra ‚Äúfantasmas‚Äù
						.sort((a, b) => (b.fotos + b.cardapio + b.telefone) - (a.fotos + a.cardapio + a.telefone));

					if (!itensOrdenados.length) {
						tabelaBotoes.innerHTML = `<tr><td colspan="4" style="text-align:center; color:#999;">Nenhum clique encontrado</td></tr>`;
					} else {
						tabelaBotoes.innerHTML = itensOrdenados.map(it => {
							const anterior = botoesAnterioresTemp[it.estId] || {};
							const alterou = (anterior.fotos !== it.fotos) ||
								(anterior.cardapio !== it.cardapio) ||
								(anterior.telefone !== it.telefone);

							return `
      <tr style="${alterou ? 'color:yellow; font-weight:bold;' : ''}">
        <td>${it.estId}</td>
        <td style="text-align:center">${it.fotos}</td>
        <td style="text-align:center">${it.cardapio}</td>
        <td style="text-align:center">${it.telefone}</td>
      </tr>
    `;
						}).join("");

						// salvar os atuais para compara√ß√£o futura
						itensOrdenados.forEach(it => {
							botoesAnteriores[it.estId] = { fotos: it.fotos, cardapio: it.cardapio, telefone: it.telefone };
						});
					}

					localStorage.setItem("valoresAnterioresBotoes", JSON.stringify(botoesAnteriores));



					// ‚ö†Ô∏è s√≥ libere o bot√£o depois de carregar tamb√©m a tabela "Onde Comer"
					await carregarTabelaOndeComer();
				} finally {
					stopLoading();               // üîµ volta ao azul s√≥ depois de TUDO
				}
			});





			////////////
		</script>

		<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
		<script>
			document.getElementById("btnExportar").addEventListener("click", () => {
				const elemento = document.querySelector(".container");
				const opt = {
					margin: 0.3,
					filename: `relatorio-${new Date().toISOString().split("T")[0]}.pdf`,
					image: { type: 'jpeg', quality: 0.98 },
					html2canvas: { scale: 2 },
					jsPDF: { unit: 'in', format: 'a4', orientation: 'portrait' }
				};
				html2pdf().set(opt).from(elemento).save();
			});
		</script>

		<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
		<script>
			document.getElementById("btnExportarExcel").addEventListener("click", async () => {
				const tabela = document.getElementById("tabelaResultados");
				const linhas = tabela.querySelectorAll("tr");

				const totalAcessos = document.getElementById("totalAcessos").innerText;
				const usuariosUnicos = document.getElementById("usuariosUnicos").innerText;

				const tipo = document.getElementById("tipoRelatorio").value;
				const dataHoje = new Date().toISOString().slice(0, 10);
				let dataReferencia = dataHoje;

				if (tipo === "diario") {
					dataReferencia = document.getElementById("filtroData").value;
				} else if (tipo === "mensal") {
					dataReferencia = document.getElementById("filtroMes").value;
				} else if (tipo === "semanal") {
					const mes = document.getElementById("filtroMes").value;
					const semana = document.getElementById("filtroSemana").value;
					dataReferencia = `Semana ${semana} / ${mes}`;
				}

				// üîç Acessos por cidade
				const snapAcessos = await firebase.database().ref("acessosPorDia").once("value");
				const dadosAcessos = snapAcessos.val() || {};

				let cidades = {};
				Object.entries(dadosAcessos).forEach(([dia, info]) => {
					const detalhados = info.detalhados || {};
					Object.values(detalhados).forEach((acesso) => {
						const cidade = acesso.cidade || "Desconhecida";
						if (!cidades[cidade]) cidades[cidade] = 0;
						cidades[cidade]++;
					});
				});

				const data = [
					["Data do Relat√≥rio:", dataReferencia],
					[],
					["Resumo de Acessos", ""],
					["Total de Acessos", totalAcessos],
					["Usu√°rios √önicos", usuariosUnicos],
					[],
					["Resumo por Cidade", ""],
				];

				Object.entries(cidades).sort((a, b) => b[1] - a[1]).forEach(([cidade, total]) => {
					data.push([cidade, total]);
				});

				data.push([]);
				data.push(["Cliques por Categoria", ""]);
				data.push(["Categoria", "Cliques"]);

				linhas.forEach(row => {
					const cols = row.querySelectorAll("td");
					if (cols.length === 2) {
						const categoria = cols[0].innerText;
						const cliques = cols[1].innerText;
						data.push([categoria, parseInt(cliques)]);
					}
				});

				const ws = XLSX.utils.aoa_to_sheet(data);
				const wb = XLSX.utils.book_new();
				XLSX.utils.book_append_sheet(wb, ws, "Relat√≥rio");

				const nomeArquivo = `relatorio-${dataHoje}.xlsx`;
				XLSX.writeFile(wb, nomeArquivo);
			});

			document.addEventListener("DOMContentLoaded", () => {
				const hoje = new Date().toISOString().split("T")[0];
				const inputData = document.getElementById("filtroData");
				if (inputData) inputData.value = hoje;
			});

		</script>















		<script>
			// Utilit√°rio: gera lista de datas (YYYY-MM-DD) do per√≠odo escolhido
			async function listarDatasPeriodo(tipo) {
				const hoje = new Date();
				const pad = n => String(n).padStart(2, '0');

				// l√™ UI j√° existente (rc.html tem "Tipo de Relat√≥rio" e campos de data) 
				const tipoRel = tipo || document.getElementById('tipoRelatorio').value; // diario, semanal, mensal
				let datas = [];

				if (tipoRel === 'diario') {
					const d = document.getElementById('filtroData').value || hoje.toISOString().slice(0, 10);
					datas = [d];
				} else if (tipoRel === 'semanal') {
					// usa m√™s atual do filtroMes se existir; e semana do filtroSemana
					const m = (document.getElementById('filtroMes').value || hoje.toISOString().slice(0, 7)); // YYYY-MM
					const semana = Number(document.getElementById('filtroSemana').value || 1);
					const [ano, mes] = m.split('-').map(Number);
					const faixas = {
						1: [1, 7], 2: [8, 14], 3: [15, 21], 4: [22, 28], 5: [29, 31]
					}[semana] || [1, 7];
					for (let dia = faixas[0]; dia <= faixas[1]; dia++) {
						const data = new Date(ano, mes - 1, dia);
						if (data.getMonth() + 1 === mes) {
							datas.push(`${ano}-${pad(mes)}-${pad(dia)}`);
						}
					}
				} else { // mensal
					const m = (document.getElementById('filtroMes').value || hoje.toISOString().slice(0, 7)); // YYYY-MM
					const [ano, mes] = m.split('-').map(Number);
					const ultimo = new Date(ano, mes, 0).getDate();
					for (let dia = 1; dia <= ultimo; dia++) {
						datas.push(`${ano}-${pad(mes)}-${pad(dia)}`);
					}
				}
				return datas;
			}

			// L√™ um n√≥ "1 n√≠vel" (ex.: cliquesCardapiosOndeComer/2025-08-16) e acumula por estabelecimento
			async function somarNoPorDatas(basePath, datas) {
				const db = firebase.database();
				const total = {}; // { estabId: numero }

				for (const d of datas) {
					const snap = await db.ref(`${basePath}/${d}`).once('value');
					const val = snap.val() || {};
					Object.keys(val).forEach(id => {
						total[id] = (total[id] || 0) + (typeof val[id] === 'number' ? val[id] : 0);
					});
				}
				return total;
			}


			// Popula a tabela üìã Card√°pios (Onde Comer) somando Card√°pio + WhatsApp (+ Fotos opcional)
			// Popula a tabela üìã Card√°pios (Onde Comer) somando Card√°pio + WhatsApp
			async function carregarTabelaOndeComer() {
				const tbody = document.getElementById('tabelaOndeComerCardapio');
				if (!tbody) return;

				// feedback visual local da pr√≥pria tabela
				tbody.innerHTML = `<tr><td colspan="4" style="text-align:center; color:#999">Carregando...</td></tr>`;

				// usa os filtros j√° existentes do rc.html
				const datas = await listarDatasPeriodo();

				// l√™ e soma cada fonte em paralelo
				const [totCardapio, totWhats] = await Promise.all([
					somarNoPorDatas('cliquesCardapiosOndeComer', datas),
					somarNoPorDatas('cliquesWhatsOndeComer', datas)
				]);

				// consolida por estabelecimento
				const estabSet = new Set([...Object.keys(totCardapio), ...Object.keys(totWhats)]);
				const linhas = [];
				estabSet.forEach(id => {
					linhas.push({ id, cardapio: totCardapio[id] || 0, whatsapp: totWhats[id] || 0 });
				});

				// ordena por total desc
				linhas.sort((a, b) => (b.cardapio + b.whatsapp) - (a.cardapio + a.whatsapp));

				// render
				if (!linhas.length) {
					tbody.innerHTML = `<tr><td colspan="4" style="text-align:center; color:#999">Nenhum clique encontrado</td></tr>`;
					return;
				}

				tbody.innerHTML = linhas.map(({ id, cardapio, whatsapp }) => `
    <tr>
      <td>${id}</td>
      <td style="text-align:center">${cardapio}</td>
      <td style="text-align:center">${whatsapp}</td>
    </tr>
  `).join('');
			}


			async function carregarTabelaAcessosMenu() {
    const tbody = document.querySelector('#tabelaAcessosMenu tbody');
    if (!tbody) return;

    firebase.database().ref('estatisticas/cliques_menu').once('value', (snapshot) => {
        let html = '';
        const dados = snapshot.val();
        
        if (dados) {
            // Converte objeto em array e ordena por data (mais recente primeiro)
            const lista = Object.values(dados).reverse();
            
            lista.forEach(item => {
                html += `
                    <tr>
                        <td>${item.dataHora}</td>
                        <td>${item.categoria || 'Geral'}</td>
                        <td>${item.titulo}</td>
                    </tr>
                `;
            });
            tbody.innerHTML = html;
        } else {
            tbody.innerHTML = '<tr><td colspan="3">Nenhum clique registado.</td></tr>';
        }
    });
}



			// L√™ os dias do per√≠odo j√° selecionado no filtro (di√°rio/semanal/mensal)
			// A p√°gina j√° usa listarDatasPeriodo() em outras tabelas.
			// Vamos reaproveitar exatamente o mesmo helper.
			async function carregarTabelaGruposWhats() {
				const tbody = document.getElementById('tabelaGruposWhats');
				if (!tbody) return;

				// feedback visual
				tbody.innerHTML = `<tr><td colspan="2" style="text-align:center; color:#999;">Carregando...</td></tr>`;

				const db = firebase.database();
				const datas = await listarDatasPeriodo(); // j√° existe e √© usada na tabela "Onde Comer" :contentReference[oaicite:1]{index=1}

				// totalizador por ID de grupo (id = slug/n√≥ usado quando registra o clique do bot√£o)
				const totais = {}; // { grupoId: total }

				// Para cada dia, lemos cliquesPorBotao/<data> e somamos apenas o tipo 'grupoWhatsapp'
				for (const d of datas) {
					const snap = await db.ref(`cliquesPorBotao/${d}`).once('value');
					const val = snap.val() || {};
					// val = { [id]: { grupoWhatsapp: number, ...outros tipos } }
					Object.entries(val).forEach(([id, tipos]) => {
						const qtd = Number(tipos?.grupoWhatsapp || 0);
						if (qtd > 0) {
							totais[id] = (totais[id] || 0) + qtd;
						}
					});
				}

				// monta linhas ordenadas por total desc
				const linhas = Object.entries(totais)
					.map(([id, total]) => ({ id, total }))
					.sort((a, b) => b.total - a.total);

				if (!linhas.length) {
					tbody.innerHTML = `<tr><td colspan="2" style="text-align:center; color:#999;">Nenhum clique encontrado</td></tr>`;
					return;
				}

				tbody.innerHTML = linhas.map(({ id, total }) => `
      <tr>
        <td>${id}</td>
        <td style="text-align:center">${total}</td>
      </tr>
    `).join('');
			}



		async function carregarTabelaCliquesImoveis() {
  const tbody = document.getElementById('tabelaCliquesImoveis');
  if (!tbody) return;
  tbody.innerHTML = `<tr><td colspan="5" style="text-align:center; color:#999;">Carregando...</td></tr>`;

  const datas = await listarDatasPeriodo();
  const db = firebase.database();

  const tot = {};                 // { id: {whats, fotos} }
  const titulos = {};             // { id: titulo }
  const mapCorretor = {};         // { id: corretor }
  const mapProprietario = {};     // { id: proprietario }

  const norm = (raw) => {
    if (!raw) return '';
    if (Array.isArray(raw)) return raw.filter(Boolean).join(', ');
    if (typeof raw === 'object') return String(raw.nome || raw.label || raw.titulo || raw.text || '').trim();
    return String(raw).trim();
  };

  // 1) Soma cliques por dia e captura r√≥tulos do n√≥ di√°rio
  for (const d of datas) {
    const snap = await db.ref(`imoveisCliquesPorDia/${d}`).once('value');
    const dia = snap.val() || {};
    Object.entries(dia).forEach(([id, info]) => {
      const w = Number(info?.whatsapp || 0);
      const f = Number(info?.fotos || 0);

      const t = (typeof info?.titulo === 'string' && info.titulo) || '';
      const corretor = norm(info?.corretor ?? info?.corretores);
      const proprietario = norm(info?.proprietario ?? info?.proprietaria);

      if (t && !titulos[id]) titulos[id] = t;
      if (corretor && !mapCorretor[id]) mapCorretor[id] = corretor;
      if (proprietario && !mapProprietario[id]) mapProprietario[id] = proprietario;

      if (w + f > 0) {
        if (!tot[id]) tot[id] = { whats: 0, fotos: 0 };
        tot[id].whats += w;
        tot[id].fotos += f;
      }
    });
  }

  // 2) Completa faltantes pelo cadastro do im√≥vel
  const faltantes = Object.keys(tot).filter(id => !mapCorretor[id] || !mapProprietario[id] || !titulos[id]);
  await Promise.all(faltantes.map(async (id) => {
    for (const path of [`imoveis/dados/${id}`, `imoveis/${id}`]) {
      const s = await db.ref(path).once('value');
      const v = s.val();
      if (!v) continue;
      if (!titulos[id] && v?.titulo) titulos[id] = String(v.titulo);
      if (!mapCorretor[id]) {
        const c = norm(v?.corretor ?? v?.corretores);
        if (c) mapCorretor[id] = c;
      }
      if (!mapProprietario[id]) {
        const p = norm(v?.proprietario ?? v?.proprietaria ?? v?.owner);
        if (p) mapProprietario[id] = p;
      }
      if (titulos[id] && mapCorretor[id] && mapProprietario[id]) break;
    }
  }));

  // 3) Monta linhas
  const linhas = Object.entries(tot)
    .map(([id, v]) => ({
      titulo: titulos[id] || id,
      proprietario: mapProprietario[id] || "‚Äî",
      corretor: mapCorretor[id] || "‚Äî",
      whats: v.whats,
      fotos: v.fotos
    }))
    .filter(r => r.whats + r.fotos > 0)
    .sort((a, b) => (b.whats + b.fotos) - (a.whats + a.fotos));

  if (!linhas.length) {
    tbody.innerHTML = `<tr><td colspan="5" style="text-align:center; color:#999;">Nenhum clique encontrado</td></tr>`;
    return;
  }

  tbody.innerHTML = linhas.map(l => `
    <tr>
      <td>${l.titulo}</td>
      <td>${l.proprietario}</td>
      <td>${l.corretor}</td>
      <td style="text-align:center">${l.whats}</td>
      <td style="text-align:center">${l.fotos}</td>
    </tr>
  `).join('');
}



			// mant√©m as chamadas j√° existentes
			document.addEventListener('DOMContentLoaded', carregarTabelaCliquesImoveis);
			document.getElementById('btnBuscar')?.addEventListener('click', carregarTabelaCliquesImoveis);



			async function carregarTabelaContatosImoveis() {
				const tbody = document.getElementById('tabelaContatosImoveis');
				if (!tbody) return;
				tbody.innerHTML = `<tr><td colspan="4" style="text-align:center; color:#999;">Carregando...</td></tr>`;

				const datas = await listarDatasPeriodo();
				const db = firebase.database();
				const linhas = []; // { ts, dataHora, titulo, nome, fone }

				for (const d of datas) {
					const snapDia = await db.ref(`imoveis/contatos/${d}`).once('value');
					const porImovel = snapDia.val() || {};
					Object.entries(porImovel).forEach(([imovelId, contatos]) => {
						Object.values(contatos || {}).forEach(c => {
							const ts = Number(c.ts || 0);
							const dt = ts ? new Date(ts) : null;
							const dataHora = dt
								? `${dt.toLocaleDateString()} ${String(dt.getHours()).padStart(2, '0')}:${String(dt.getMinutes()).padStart(2, '0')}`
								: d;
							linhas.push({
								ts,
								dataHora,
								titulo: c.imovelTitulo || imovelId,
								nome: c.nome || "‚Äî",
								fone: c.destinoFone ? `(${c.destinoFone.slice(0, 2)}) ${c.destinoFone.slice(2)}` : "‚Äî",
								corretor: (c.corretor || c.responsavel || "‚Äî")

							});
						});
					});
				}

				// ordena do mais recente pro mais antigo
				linhas.sort((a, b) => (b.ts || 0) - (a.ts || 0));

				if (!linhas.length) {
					tbody.innerHTML = `<tr><td colspan="4" style="text-align:center; color:#999;">Nenhum contato encontrado</td></tr>`;
					return;
				}

				tbody.innerHTML = linhas.map(l => `
    <tr>
      <td>${l.dataHora}</td>
      <td>${l.titulo}</td>
      <td>${l.nome}</td>
      <td style="white-space:nowrap">${l.fone}</td>
	 <td>${l.corretor}</td>
    </tr>
  `).join('');
			}

			// dispara junto com os outros carregamentos do relat√≥rio
			document.addEventListener('DOMContentLoaded', carregarTabelaContatosImoveis);
			document.getElementById('btnBuscar')?.addEventListener('click', carregarTabelaContatosImoveis);





			// Chamar junto com as outras tabelas:
			document.addEventListener('DOMContentLoaded', () => {
				carregarTabelaGruposWhats(); // inicial, como j√° √© feito para Onde Comer :contentReference[oaicite:2]{index=2}
			});

			// E tamb√©m no bot√£o "Buscar", junto com as demais atualiza√ß√µes:
			const _btn = document.getElementById('btnBuscar');
			if (_btn) _btn.addEventListener('click', carregarTabelaGruposWhats);









			// Chame ao abrir a p√°gina e tamb√©m no bot√£o "Buscar"
			document.addEventListener('DOMContentLoaded', () => {
				carregarTabelaOndeComer();        // inicial
				const btn = document.getElementById('btnBuscar');
				if (btn) btn.addEventListener('click', carregarTabelaOndeComer);
			});
		</script>


		<div id="loadingOverlay" class="loader-overlay" aria-live="polite" aria-busy="true">
			<div class="loader-box">
				<div class="loader" role="status" aria-label="Carregando"></div>
				<div class="loader-text">Carregando‚Ä¶</div>
			</div>
		</div>




</body>

</html>