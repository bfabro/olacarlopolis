<!DOCTYPE html>
<html lang="pt-BR">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Admin ‚Ä¢ Pagamentos 2</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #0b0f14;
      --panel: #11161d;
      --soft: #182029;
      --text: #e3e7ee;
      --muted: #9aa6b2;
      --brand: #5dd4ff;
      --ok: #22c55e;
      --no: #ef4444
    }

    * {
      box-sizing: border-box
    }

    html,
    body {
      height: 100%
    }

    body {
      margin: 0;
      background: var(--bg);
      color: var(--text);
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Helvetica Neue", sans-serif
    }

    .wrap {
      max-width: 1240px;
      margin: 0 auto;
      padding: 24px
    }

    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 16px;
      margin-bottom: 18px
    }

    h1 {
      margin: 0;
      font-size: 22px
    }

    .card {
      background: var(--panel);
      border: 1px solid var(--soft);
      border-radius: 14px;
      padding: 14px
    }

    .toolbar {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      align-items: center;
      margin-bottom: 12px
    }

    input,
    select,
    button,
    textarea {
      font: inherit;
      color: var(--text)
    }

    input[type=text],
    input[type=email],
    input[type=password],
    textarea,
    select {
      background: #0f141b;
      border: 1px solid var(--soft);
      border-radius: 10px;
      padding: 8px 10px;
      outline: none
    }

    input::placeholder,
    textarea::placeholder {
      color: var(--muted)
    }

    button {
      border: 0;
      border-radius: 10px;
      background: var(--brand);
      color: #061018;
      font-weight: 700;
      padding: 8px 12px;
      cursor: pointer
    }

    button[disabled] {
      opacity: .6;
      cursor: not-allowed
    }

    .table-wrap {
      background: var(--panel);
      border: 1px solid var(--soft);
      border-radius: 14px;
      overflow-x: hidden;
      /* <‚Äî mant√©m a barra geral oculta */
      overflow-y: auto;
      width: 100%;
    }

    table {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0;
      table-layout: fixed;
      min-width: 0;
    }

    thead th {
      position: sticky;
      top: 0;
      background: linear-gradient(#121923, #0e141c);
      border-bottom: 1px solid var(--soft);
      color: var(--muted);
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: .04em;
      padding: 10px 8px;
      text-align: left
    }

    td {
      padding: 10px 8px;
      border-bottom: 1px solid #121921
    }

    tbody tr:hover {
      background: #0f151d
    }

    .idx {
      width: 46px;
      text-align: center
    }

    .cat {
      width: 160px;
    }

    /* mant√©m a largura da coluna de status */
    .status-chip.is-ok {
      border-color: rgba(34, 197, 94, .35);
    }

    .status-chip.is-no {
      border-color: rgba(239, 68, 68, .35);
    }

    .nome {
      min-width: 240px;
      font-weight: 600
    }

    .payer {
      min-width: 200px
    }

    .obs {
      min-width: 260px
    }

    .month {
      width: 82px;
      text-align: center
    }

    .acao {
      width: 160px;
      text-align: center;
      position: sticky;
      right: 0;
      background: linear-gradient(90deg, #0f151d, #0e141c)
    }

    .chip {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 6px 10px;
      border-radius: 10px;
      background: #0f141b;
      border: 1px solid var(--soft);
      color: var(--muted);
      font-size: 12px
    }

    .status-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%
    }

    .dot-ok {
      background: var(--ok)
    }

    .dot-no {
      background: var(--no)
    }

    .muted {
      color: var(--muted);
      font-size: 12px
    }

    .sr-only {
      position: absolute;
      left: -9999px;
      width: 1px;
      height: 1px;
      overflow: hidden
    }
  </style>

  <style>
    /* === meses com scroll por linha === */
    .months {
      width: 520px;
      /* ajuste se quiser mais/menos vis√≠vel */
      padding-left: 0 !important;
      padding-right: 0 !important;
    }

    .months-scroll {
      display: flex;
      gap: 10px;
      align-items: center;
      max-width: 100%;
      /* <--- respeita a largura da c√©lula */
      overflow-x: auto;
      /* <--- barra por linha */
      overflow-y: hidden;
      padding: 6px 8px 8px;
      /* espa√ßo pra barra aparecer */
      -webkit-overflow-scrolling: touch;
      scrollbar-width: thin;
    }

    .mchip {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      white-space: nowrap;
      background: #0f141b;
      border: 1px solid var(--soft);
      border-radius: 10px;
      padding: 6px 8px;
      font-size: 12px;
    }

    .mchip input {
      transform: translateY(1px);
    }

    /* linha com scroll pr√≥prio */
    .rowwrap {
      padding: 0 !important;
    }

    .row-scroll {
      position: relative;
      /* necess√°rio p/ sticky funcionar */
      display: flex;
      align-items: flex-start;
      gap: 12px;
      overflow-x: auto;
      overflow-y: hidden;
      /* <‚Äî √∫nico scroll por cliente */
      padding: 10px;
      max-width: 100%;
      -webkit-overflow-scrolling: touch;
      scrollbar-width: thin;
      background: #0f141b;
      border: 1px solid var(--soft);
      border-radius: 10px;
    }

    /* ‚Äúsub-c√©lulas‚Äù dentro do carrossel */
    .rcell {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .rcell.status {
      position: sticky;
      left: 0;
      z-index: 2;
      /* <‚Äî fixa o status */
      min-width: 160px;
      flex: 0 0 160px;
      /* largura fixa */
      background: #0f141b;
      /* cor de fundo p/ cobrir atr√°s */
      box-shadow: 10px 0 12px -10px rgba(0, 0, 0, .6);
      /* leve sombreado na borda */
      border-right: 1px solid var(--soft);
      min-width: 160px
    }

    .rcell.nome {
      min-width: 260px
    }

    .rcell.payer {
      min-width: 340px
    }

    .rcell.obs {
      min-width: 300px
    }

    .rcell.meses {
      min-width: 560px
    }

    .rcell.acao {
      min-width: 160px;
      align-items: center;
      justify-content: center
    }

    /* reaproveita seus chips de m√™s dentro do carrossel */
    .row-scroll .months-scroll {
      display: flex;
      gap: 10px;
      align-items: center;
      overflow: visible;
      /* <‚Äî sem scroll aqui */
      padding: 6px 6px 8px;
      -webkit-overflow-scrolling: auto;
      background: #0c1218;
      border: 1px solid var(--soft);
      border-radius: 10px;
    }

    /* Bot√£o ‚ÄúAtualizar‚Äù fixo dentro do bloco Status */
    .rcell.status .btn-save-sticky {
      margin-top: 8px;
      width: 100%;
      white-space: nowrap;
      position: sticky;
      /* gruda junto com o pr√≥prio bloco que j√° √© sticky */
      left: 0;
      /* acompanha o status √† esquerda */
      z-index: 3;
    }

    /* ===== MOBILE TWEAKS ===== */
    @media (max-width: 768px) {
      .wrap {
        padding: 10px
      }

      /* Permite rolar lateralmente toda a tabela */
      .table-wrap {
        display: block;
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
        overscroll-behavior-x: contain;
        padding-bottom: 10px;
      }

      /* For√ßa a tabela a ocupar largura total e liberar scroll */
      table {
        display: block;
        width: max-content;
        /* ocupa s√≥ o necess√°rio */
        min-width: 1000px;
        /* largura m√≠nima √∫til */
      }

      /* Cada linha agora herda o scroll do container */
      .row-scroll {
        flex-wrap: nowrap;
        overflow: visible;
        /* desativa scroll individual */
        min-width: auto;
      }

      /* Colunas mais compactas */
      .rcell.status {
        min-width: 120px;
        flex: 0 0 120px
      }

      .rcell.nome {
        min-width: 180px
      }

      .rcell.payer {
        min-width: 180px
      }

      .rcell.obs {
        min-width: 220px
      }

      .rcell.meses {
        min-width: 520px
      }

      .rcell.acao {
        min-width: 120px
      }

      /* Chips menores e mais pr√≥ximos */
      .mchip {
        padding: 4px 6px;
        font-size: 11px;
        gap: 5px
      }

      .months-scroll {
        gap: 6px;
        padding: 5px 5px 7px
      }

      /* Deixa r√≥tulos e bot√µes mais leves */
      .label.muted {
        font-size: 10px
      }

      .btn-save-sticky {
        font-size: 12px;
        padding: 6px 8px;
      }
    }


    .status-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: #0f141b;
      border: 1px solid var(--soft);
      border-radius: 10px;
      padding: 6px 10px;
      margin-bottom: 6px;
    }

    .status-header .cliente-nome {
      font-weight: 600;
      color: var(--text);
      font-size: 13px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .btn-save-sticky {
      background: var(--brand);
      color: #061018;
      border: none;
      border-radius: 8px;
      padding: 6px 9px;
      font-size: 14px;
      cursor: pointer;
      transition: 0.2s;
    }

    .btn-save-sticky:hover {
      background: #79ddff;
    }

    @media (max-width: 768px) {
      .status-header {
        flex-direction: row;
        gap: 6px;
        padding: 6px 8px;
      }

      .status-header .cliente-nome {
        font-size: 12px;
        max-width: 140px;
      }

      .btn-save-sticky {
        font-size: 16px;
        padding: 4px 6px;
      }
    }

    /* bloco status reformulado */
    .status-title {
      display: flex;
      align-items: flex-start;
      justify-content: flex-start;
      margin-bottom: 6px;
    }

    .cliente-nome {
      font-weight: 700;
      font-size: 15px;
      /* maior e leg√≠vel */
      line-height: 1.2;
      color: var(--text);
      white-space: normal;
      /* permite 2 linhas no mobile */
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }

    .status-row {
      display: flex;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
      /* no mobile pode quebrar */
      background: #0f141b;
      border: 1px solid var(--soft);
      border-radius: 10px;
      padding: 6px 8px;
    }

    .btn-icon {
      background: var(--brand);
      color: #061018;
      border: 0;
      border-radius: 10px;
      padding: 6px 10px;
      font-size: 16px;
      /* √≠cone maior */
      cursor: pointer;
    }

    .btn-icon:hover {
      background: #79ddff;
    }

    /* d√° um pouco mais de largura pro status ‚Äúgrudar‚Äù melhor o conte√∫do */
    .rcell.status {
      min-width: 190px;
      flex: 0 0 190px;
    }

    /* MOBILE */
    @media (max-width:768px) {
      .rcell.status {
        min-width: 180px;
        flex: 0 0 180px;
      }

      .cliente-nome {
        font-size: 14px;
        -webkit-line-clamp: 2;
      }

      .status-row {
        gap: 8px;
        padding: 6px;
      }

      .btn-icon {
        font-size: 18px;
        padding: 6px 8px;
      }
    }

    .modal-pix {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, .65);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9999;
    }

    .modal-box {
      background: #11161d;
      padding: 6px;
      border-radius: 14px;
      width: 350px;
      text-align: center;
      border: 1px solid #182029;
    }

    .pix-line {
      background: #0f141b;
      padding: 10px;
      border-radius: 10px;
      font-size: 13px;
      word-break: break-all;
      margin-top: 10px;
    }

    .btn-close {
      margin-top: 12px;
      background: #ef4444;
      color: white;
    }

    .btn-copy {
      margin-top: 8px;
    }


    /* m√™s marcado como "entrada" */
    .mchip.is-entry {
      border-color: rgba(8, 245, 12, 0.885);
      background: rgba(93, 212, 255, .10);
      box-shadow: 0 0 0 1px rgba(93, 212, 255, .25) inset;
    }

    .mchip.is-entry::after {
      content: "üìå";
      margin-left: 6px;
      font-size: 12px;
      opacity: .9;
    }

    .chip.is-active {
      border-color: var(--brand);
      box-shadow: 0 0 0 1px var(--brand) inset;
    }
  </style>

</head>

<body>
  <div class="wrap">
    <header>
      <div style="display:flex; align-items:center; gap:12px">
        <h1>üìí Pagamentos</h1>
        <span class="chip" id="chipPago" style="cursor:pointer">
          <span class="status-dot dot-ok"></span> Pago
        </span>

        <span class="chip" id="chipAberto" style="cursor:pointer">
          <span class="status-dot dot-no"></span> Em aberto
        </span>

      </div>
      <div class="chip" id="userBox" style="display:none">
        <span id="userEmail">‚Äî</span>
        <button id="btnLogout">Sair</button>
      </div>
    </header>

    <!-- LOGIN -->
    <section id="viewLogin" class="card" style="max-width:380px; margin:10vh auto">
      <h2 style="margin:0 0 12px; font-size:18px">Entrar</h2>
      <div style="display:grid; gap:10px">
        <input id="email" type="email" placeholder="Seu e-mail" autocomplete="username" />
        <input id="senha" type="password" placeholder="Sua senha" autocomplete="current-password" />
        <button id="btnLogin">Entrar</button>
        <div class="muted">Crie usu√°rios no Firebase Auth ‚Üí Users.</div>
        <div id="loginMsg" class="muted"></div>
      </div>
    </section>

    <!-- PAINEL -->
    <section id="viewPainel" style="display:none">
      <div class="toolbar">
        <div class="card">
          <label for="ano">Ano:&nbsp;</label>
          <select id="ano"></select>
        </div>
        <div class="card"><input id="filtro" type="text" placeholder="Pesquisar por nome ou categoria‚Ä¶" /></div>
        <div class="card"><button id="btnSync">Sincronizar com script.js</button></div>
        <div class="card"><button id="btnCSV">Exportar CSV</button></div>
        <div class="card">
          <button id="btnToggleInativos">Ver inativos</button>
        </div>
        <div class="card muted" id="sumario">‚Äî</div>
      </div>



      <!-- LOADER -->
      <div id="loaderBox" class="card" style="margin-bottom:12px; display:none">
        <div style="display:flex; align-items:center; gap:12px">
          <div style="flex:1">
            <div class="muted" id="loaderText">Carregando‚Ä¶</div>
            <div style="height:8px; background:#0f141b; border-radius:6px; overflow:hidden; margin-top:6px">
              <div id="loaderBar" style="height:100%; width:0%; background:var(--brand); transition:width .2s">
              </div>
            </div>
          </div>
          <div id="loaderPct" class="muted">0%</div>
        </div>
      </div>






      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th class="idx">#</th>
              <th>RECEBIMENTO</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
    </section>
  </div>

  <!-- Loader: baixa /script.js e extrai apenas const statusEstabelecimentos = { ... } -->
  <script>
    window.__STATUS__ = null;


    async function loadStatusFromMainScript() {
      try {
        const res = await fetch('/script.js', { cache: 'no-store' });
        const code = await res.text();

        // 1) Captura SOMENTE o objeto (sem o ;)
        //    Ex.: const statusEstabelecimentos = { ... };
        const m = code.match(/const\s+statusEstabelecimentos\s*=\s*(\{[\s\S]*?\});?/m);
        if (!m || !m[1]) {
          console.warn('statusEstabelecimentos n√£o encontrado no script.js');
          return null;
        }

        // 2) S√≥ o literal do objeto
        let objCode = m[1];

        // 3) (robusto) Remove v√≠rgula √† direita antes de fechar bloco, caso exista em alguma linha
        //    (n√£o deveria quebrar em JS moderno, mas deixa compat√≠vel)
        objCode = objCode.replace(/,(\s*[}\]])/g, '$1');

        // 4) Avalia s√≥ o objeto
        const obj = (new Function('return (' + objCode + ')'))();

        // 5) Armazena em cache global
        window.__STATUS__ = obj;
        return obj;
      } catch (e) {
        console.error('Falha ao ler statusEstabelecimentos do script.js', e);
        return null;
      }
    }
  </script>

  <script>
    async function loadAllowedKeysFromScript() {
      const res = await fetch('/script.js', { cache: 'no-store' });
      const code = await res.text();

      // 1) BLOCO COM√âRCIOS: do come√ßo at√© "// FIM COMERCIOS"
      const ateFimComercios = code.split('// FIM COMERCIOS')[0] || '';

      // 2) BLOCO SERVI√áOS: entre "// INICIO SERVI√áOS" e "/// INICIO SETOR PUBLICO"
      let blocoServ = '';
      const iniServ = code.indexOf('// INICIO SERVI√áOS');
      const iniSetorPublico = code.indexOf('/// INICIO SETOR PUBLICO');
      if (iniServ !== -1 && iniSetorPublico !== -1 && iniSetorPublico > iniServ) {
        blocoServ = code.slice(iniServ, iniSetorPublico);
      }

      // 3) extrai chaves no formato:  nome: "s"  |  nome: "n"
      const rx = /(?:["']([^"']+)["']|([a-z0-9_]+))\s*:\s*"(?:s|n)"/gi;

      const allow = new Set();
      for (const m of ateFimComercios.matchAll(rx)) allow.add(m[1] || m[2]);
      for (const m of blocoServ.matchAll(rx)) allow.add(m[1] || m[2]);


      return allow;
    }
  </script>



  <script>

    window.__PROFILE_MAP__ = null;

    function normalizeNameLocal(str) {
      return String(str || '')
        .toLowerCase()
        .normalize('NFD')
        .replace(/[\u0300-\u036f]/g, '')     // remove acentos
        .replace(/\s+/g, '-')                // espa√ßos -> h√≠fen
        .replace(/[^a-z0-9\-]/g, '');        // s√≥ letras/n√∫meros/h√≠fen
    }

    async function loadProfileMapFromScript() {
      if (window.__PROFILE_MAP__) return window.__PROFILE_MAP__;

      try {
        const res = await fetch('/script.js', { cache: 'no-store' });
        const code = await res.text();

        // pega s√≥ o array categories = [ ... ];
        const m = code.match(/const\s+categories\s*=\s*(\[[\s\S]*?\]);/m);
        if (!m || !m[1]) {
          console.warn('categories n√£o encontrado em script.js');
          window.__PROFILE_MAP__ = {
            byId: {}, byNoHyphen: {}, phonesById: {}, phonesByNoHyphen: {}, namesById: {},
            namesByNoHyphen: {}
          };
          return window.__PROFILE_MAP__;
        }

        let arrCode = m[1];

        // remove v√≠rgulas sobrando antes de ] ou }
        arrCode = arrCode.replace(/,(\s*[}\]])/g, '$1');

        const categories = (new Function('return (' + arrCode + ')'))();

        const byId = {};
        const byNoHyphen = {};
        const phonesById = {};
        const phonesByNoHyphen = {};
        const namesById = {};
        const namesByNoHyphen = {};

        (categories || []).forEach(cat => {
          (cat.establishments || []).forEach(est => {
            // id "bonito" com h√≠fen
            const idNorm =
              est.nomeNormalizado ||
              normalizeNameLocal(est.name || '');

            if (!idNorm) return;

            // FOTO
          // FOTO ‚Äî usa SOMENTE imagem de perfil
// FOTO ‚Äî usa SOMENTE imagem de perfil
let img =
  est.image ||
  est.profileImage ||
  est.foto ||
  est.logo ||
  '';
// trava: nunca aceitar imagens de nota/falecimento no PIX
const imgLower = (img || '').toString().toLowerCase();
if (imgLower.includes('falecimento') || imgLower.includes('obito') || imgLower.includes('nota')) {
  img = '';
}


            if (img) {
              byId[idNorm] = img;
              const semHifen = idNorm.replace(/-/g, '');
              byNoHyphen[semHifen] = img;
            }

            // NOME REAL DO CLIENTE / ESTABELECIMENTO
            if (est.name) {
              namesById[idNorm] = est.name;
              namesByNoHyphen[idNorm.replace(/-/g, '')] = est.name;
            }


            // TELEFONE (pega qualquer um dos campos que voc√™ usa no site)
            const phone =
              est.whatsapp ||
              est.telefone ||
              est.celular ||
              est.contact ||
              est.phone ||
              '';

            if (phone) {
              phonesById[idNorm] = phone;
              const semHifen = idNorm.replace(/-/g, '');
              phonesByNoHyphen[semHifen] = phone;
            }
          });
        });

        window.__PROFILE_MAP__ = {
          byId, byNoHyphen, phonesById, phonesByNoHyphen, namesById,
          namesByNoHyphen
        };
        return window.__PROFILE_MAP__;
      } catch (e) {
        console.error('Falha ao montar PROFILE_MAP a partir de script.js', e);
        window.__PROFILE_MAP__ = {
          byId: {}, byNoHyphen: {}, phonesById: {}, phonesByNoHyphen: {}, namesById: {},
          namesByNoHyphen: {}
        };
        return window.__PROFILE_MAP__;
      }
    }


    async function getProfileUrlFromScript(merchantId) {
      if (!merchantId) return '';

      const maps = await loadProfileMapFromScript();
      const byId = maps.byId || {};
      const byNoHyphen = maps.byNoHyphen || {};

      const raw = String(merchantId || '').toLowerCase();

      // varia√ß√µes do mesmo id
      const rawDash = raw.replace(/_/g, '-');          // lobo_fitness -> lobo-fitness
      const norm = normalizeNameLocal(raw);        // usa o mesmo padr√£o do script.js
      const normDash = normalizeNameLocal(rawDash);

      const rawLetters = raw.replace(/[^a-z0-9]/g, '');   // tira _ - etc
      const normLetters = norm.replace(/[^a-z0-9]/g, '');

      const found =
        byId[raw] ||
        byId[rawDash] ||
        byId[norm] ||
        byId[normDash] ||
        byNoHyphen[rawLetters] ||
        byNoHyphen[normLetters] ||
        '';

      console.log('[PIX] fotoPerfilUrl', { merchantId, raw, norm, found });

      return found;
    }

    async function getPhoneFromScript(merchantId) {
      if (!merchantId) return '';

      const maps = await loadProfileMapFromScript();
      const phonesById = maps.phonesById || {};
      const phonesByNoHyphen = maps.phonesByNoHyphen || {};

      const raw = String(merchantId || '').toLowerCase();

      const rawDash = raw.replace(/_/g, '-');
      const norm = normalizeNameLocal(raw);
      const normDash = normalizeNameLocal(rawDash);

      const rawLetters = raw.replace(/[^a-z0-9]/g, '');
      const normLetters = norm.replace(/[^a-z0-9]/g, '');

      const found =
        phonesById[raw] ||
        phonesById[rawDash] ||
        phonesById[norm] ||
        phonesById[normDash] ||
        phonesByNoHyphen[rawLetters] ||
        phonesByNoHyphen[normLetters] ||
        '';

      console.log('[PIX] phoneCliente', { merchantId, raw, norm, found });

      return found;
    }

    async function getNameFromScript(merchantId) {
      if (!merchantId) return '';

      const maps = await loadProfileMapFromScript();
      const raw = merchantId.toLowerCase();

      const variations = [
        raw,
        raw.replace(/_/g, '-'),
        normalizeNameLocal(raw),
        normalizeNameLocal(raw.replace(/_/g, '-')),
        raw.replace(/[^a-z0-9]/g, ''),
        normalizeNameLocal(raw).replace(/[^a-z0-9]/g, '')
      ];

      for (const key of variations) {
        if (maps.namesById[key]) return maps.namesById[key];
        if (maps.namesByNoHyphen[key]) return maps.namesByNoHyphen[key];
      }

      return '';
    }




  </script>



  <!-- Firebase + App -->
  <script type="module">
    // ==== SUA CONFIG DO FIREBASE (j√° colada por voc√™) ====
    const firebaseConfig = {
      apiKey: "AIzaSyDWHsZSHwVFpD88ChUywjw_GdZPifdrRGI",
      authDomain: "contadoracessos.firebaseapp.com",
      databaseURL: "https://contadoracessos-default-rtdb.firebaseio.com",
      projectId: "contadoracessos",
      storageBucket: "contadoracessos.firebasestorage.app",
      messagingSenderId: "521517291315",
      appId: "1:521517291315:web:74f8d878d2d8769460d046",
      measurementId: "G-BXPWYWK61F"
    };

    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js';
    import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js';
    import { getFirestore, collection, doc, getDoc, getDocs, setDoc, updateDoc, serverTimestamp, Timestamp, query, orderBy } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js';

    // Init
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // ===== ELEMENTOS =====
    const viewLogin = document.getElementById('viewLogin');
    const viewPainel = document.getElementById('viewPainel');
    const email = document.getElementById('email');
    const senha = document.getElementById('senha');
    const btnLogin = document.getElementById('btnLogin');
    const loginMsg = document.getElementById('loginMsg');
    const userBox = document.getElementById('userBox');
    const userEmail = document.getElementById('userEmail');
    const btnLogout = document.getElementById('btnLogout');
    const selAno = document.getElementById('ano');
    const filtro = document.getElementById('filtro');
    const tbody = document.getElementById('tbody');
    const btnCSV = document.getElementById('btnCSV');
    const btnSync = document.getElementById('btnSync');
    const sumario = document.getElementById('sumario');
    const mesesKeys = ["01", "02", "03", "04", "05", "06", "07", "08", "09", "10", "11", "12"];
    const btnToggleInativos = document.getElementById('btnToggleInativos');
    window.__SHOW_INATIVOS__ = false;
    window.__LOADSEQ__ = 0; // ‚úÖ evita misturar renders antigos
    window.__FILTER_PAGO__ = false;
    window.__FILTER_ABERTO__ = false;

    const chipPago = document.getElementById('chipPago');
    const chipAberto = document.getElementById('chipAberto');

    chipPago.addEventListener('click', () => {
      window.__FILTER_PAGO__ = !window.__FILTER_PAGO__;
      if (window.__FILTER_PAGO__) window.__FILTER_ABERTO__ = false;

      chipPago.classList.toggle('is-active', window.__FILTER_PAGO__);
      chipAberto.classList.remove('is-active');

      applyViewAndFilter();
    });

    chipAberto.addEventListener('click', () => {
      window.__FILTER_ABERTO__ = !window.__FILTER_ABERTO__;
      if (window.__FILTER_ABERTO__) window.__FILTER_PAGO__ = false;

      chipAberto.classList.toggle('is-active', window.__FILTER_ABERTO__);
      chipPago.classList.remove('is-active');

      applyViewAndFilter();
    });



    // ===== LOGIN =====
    btnLogin.addEventListener('click', async () => {
      btnLogin.disabled = true; loginMsg.textContent = 'Entrando‚Ä¶';
      try {
        await signInWithEmailAndPassword(auth, email.value.trim(), senha.value.trim());
        loginMsg.textContent = '';
      } catch (e) {
        loginMsg.textContent = 'Falha ao entrar: ' + (e.code || e.message);
      } finally { btnLogin.disabled = false; }
    });
    btnLogout.addEventListener('click', () => signOut(auth));

    onAuthStateChanged(auth, async user => {
      if (user) {
        userBox.style.display = 'inline-flex';
        userEmail.textContent = user.email || 'Usu√°rio';
        viewLogin.style.display = 'none';
        viewPainel.style.display = '';
        await initPainel();
      } else {
        userBox.style.display = 'none';
        viewLogin.style.display = '';
        viewPainel.style.display = 'none';
      }
    });

    // ===== MODELO =====
    // merchants/{id} => { name, category, sort }
    // recebimentos/{year}/{merchantId} => { pagadorPadrao, observacao, meses: {"01": {pago, updatedAt, by}, ...} }

    async function initPainel() {
      const yNow = new Date().getFullYear();
      selAno.innerHTML = '';
      [yNow - 1, yNow, yNow + 1].forEach(y => {
        const o = document.createElement('option'); o.value = y; o.textContent = y; if (y === yNow) o.selected = true; selAno.appendChild(o);
      });
      selAno.onchange = loadTabela;
      filtro.oninput = applyViewAndFilter;  // em vez de applyFilter
      btnCSV.onclick = exportCSV;
      //
      //
      //
      //
      //
      //
      btnToggleInativos.onclick = () => {
        window.__SHOW_INATIVOS__ = !window.__SHOW_INATIVOS__;
        btnToggleInativos.textContent = window.__SHOW_INATIVOS__ ? 'Ver ativos ' : 'Ver inativos';
        applyViewAndFilter(); // s√≥ alterna a visualiza√ß√£o (sem recarregar)
      };



      // <-- NOVO: guarda globalmente
      window.__ALLOWED__ = await loadAllowedKeysFromScript();

      btnSync.onclick = () => doSyncFromScript(window.__ALLOWED__);

      await doSyncFromScript(window.__ALLOWED__); // auto-sync ao abrir
      await loadTabela();
    }


    function getComerciosFromStatus(map, allowedSet) {
      const out = []; let i = 0;
      for (const [id, val] of Object.entries(map || {})) {
        if (allowedSet && !allowedSet.has(id)) continue;  // <-- filtro
        i++;
        out.push({
          id,
          name: id,
          category: (val === "s" ? "Pago" : "Em aberto"),
          sort: i
        });
      }
      return out;
    }


    async function doSyncFromScript(allowed) {
      const status = window.__STATUS__ || await loadStatusFromMainScript();
      if (!status) { alert('statusEstabelecimentos n√£o encontrado (veja Console).'); return; }

      const allowedSet = allowed || window.__ALLOWED__ || await loadAllowedKeysFromScript();
      const locals = getComerciosFromStatus(status, allowedSet);

      const qMer = query(collection(db, 'merchants'), orderBy('sort'));
      const snap = await getDocs(qMer);
      const remote = new Map(snap.docs.map(d => [d.id, { id: d.id, ...d.data() }]));

      let created = 0, updated = 0;
      for (const m of locals) {
        const ref = doc(db, 'merchants', m.id);
        const has = remote.get(m.id);
        if (!has) {
          await setDoc(ref, {
            ...m,
            entradaEm: serverTimestamp() // üëà salva quando o cliente entrou
          });
          created++;
        }

        else {
          const need = (has.name !== m.name) || (has.category !== m.category) || (has.sort !== m.sort);
          if (need) { await updateDoc(ref, m); updated++; }
        }
      }
      alert(`Sync conclu√≠do. Criados: ${created}, Atualizados: ${updated}.`);
    }



    // ===== FIRESTORE HELPERS =====
    async function loadMerchants() {
      const q = query(collection(db, 'merchants'), orderBy('sort'));
      const snap = await getDocs(q);
      return snap.docs.map(d => ({ id: d.id, ...d.data() }));
    }
    // caminho: recebimentos/{ANO}/itens/{merchantId}
    function recebCol(year) {
      return collection(db, 'recebimentos', String(year), 'itens');
    }
    async function readReceb(year, merchantId) {
      const dref = doc(recebCol(year), merchantId);
      const d = await getDoc(dref);
      return d.exists() ? d.data() : {};
    }
    async function saveReceb(year, merchantId, payload) {
      const dref = doc(recebCol(year), merchantId);
      await setDoc(dref, payload, { merge: true });
    }




    function getCurrentMonthKey() {
      const m = new Date().getMonth() + 1; // 1..12
      return String(m).padStart(2, '0');     // "01".."12"
    }
    function computeStatusForRow(mesesData) {
      const cur = getCurrentMonthKey();
      return !!(mesesData?.[cur]?.pago);
    }
    function inferirEntradaPorMeses(mesesData, ano) {
      if (!mesesData) return null;

      const mesesPagos = Object.keys(mesesData)
        .filter(mm => mesesData[mm]?.pago)
        .sort(); // "01", "02", ...

      if (!mesesPagos.length) return null;

      const primeiroMes = Number(mesesPagos[0]) - 1; // 0..11
      return new Date(Number(ano), primeiroMes, 1);
    }

    function renderStatusChip(isPaid) {
      return `
    <span class="chip status-chip ${isPaid ? 'is-ok' : 'is-no'}">
      <span class="status-dot ${isPaid ? 'dot-ok' : 'dot-no'}"></span>
      ${isPaid ? 'Pago' : 'Pendente'}
    </span>
  `;
    }
    function updateRowStatusFromCheckboxes(tr) {
      const cur = getCurrentMonthKey();
      const chkCur = tr.querySelector(`.months .chk[data-mm="${cur}"]`);
      const isPaid = !!(chkCur && chkCur.checked);
      const hold = tr.querySelector('.status-holder');
      if (hold) hold.innerHTML = renderStatusChip(isPaid);
    }

    function applyEntradaUI(tr, ym) {
      // limpa marca√ß√£o anterior
      tr.querySelectorAll('.mchip.is-entry').forEach(el => el.classList.remove('is-entry'));

      if (!ym) return;

      const [yy, mm] = ym.split('-').map(Number);
      if (!yy || !mm) return;

      // sempre mant√©m a info salva no dataset (PIX usa isso)
      tr.dataset.entradaYm = ym;

      // ‚úÖ S√≥ marca visualmente se o ANO selecionado for o mesmo ano da entrada
      const anoSelecionado = Number(selAno.value);
      if (yy !== anoSelecionado) return;

      // pinta o chip do m√™s (mm = 1..12 -> "01".."12")
      const mmKey = String(mm).padStart(2, '0');
      const chip = tr.querySelector(`.mchip[data-mm="${mmKey}"]`);
      if (chip) chip.classList.add('is-entry');
    }





    // ===== TABELA =====
    async function loadTabela() {
      tbody.innerHTML = '';
      const loaderBox = document.getElementById('loaderBox');
      const loaderBar = document.getElementById('loaderBar');
      const loaderText = document.getElementById('loaderText');
      const loaderPct = document.getElementById('loaderPct');

      loaderBox.style.display = '';
      loaderBar.style.width = '0%';
      loaderPct.textContent = '0%';
      loaderText.textContent = 'Carregando clientes‚Ä¶';

      const year = selAno.value;
      const mySeq = ++window.__LOADSEQ__; // ‚úÖ esta chamada √© a "mais nova"

      const allowed = window.__ALLOWED__ || await loadAllowedKeysFromScript();
      if (mySeq !== window.__LOADSEQ__) return; // ‚úÖ cancelou? sai




      const merchantsAll = await loadMerchants();
      if (mySeq !== window.__LOADSEQ__) return; // ‚úÖ
      const merchants = allowed ? merchantsAll.filter(m => allowed.has(m.id)) : merchantsAll;
      const total = merchants.length;
      let carregados = 0;

      // ‚úÖ ordena por nome (A-Z). Se n√£o tiver name, usa o id
      merchants.sort((a, b) => {
        const an = (a.name || a.id || '').toString().localeCompare(
          (b.name || b.id || '').toString(),
          'pt-BR',
          { sensitivity: 'base' }
        );
        return an;
      });




      let i = 0; let totalPagos = 0, totalMeses = 0;
      let totalClientesAtivos = 0;
      let pagosMesAtual = 0;
      for (const m of merchants) {
        if (mySeq !== window.__LOADSEQ__) return; // ‚úÖ se clicou de novo, para aqui
        const isInativo = (m.ativo === false);

        // ‚úÖ MODO EXCLUSIVO:
        // - __SHOW_INATIVOS__ = false  => mostra s√≥ ATIVOS
        // - __SHOW_INATIVOS__ = true   => mostra s√≥ INATIVOS



        i++;
        const dados = await readReceb(year, m.id);
        // üîπ BACKFILL: definir entradaEm para clientes antigos
        if (!m.entradaEm) {
          const dataInferida = inferirEntradaPorMeses(dados.meses, year);

          if (dataInferida) {
            await updateDoc(doc(db, 'merchants', m.id), {
              entradaEm: dataInferida
            });

            // atualiza em mem√≥ria para j√° refletir na tela
            m.entradaEm = {
              toDate: () => dataInferida
            };
          }
        }

        if (mySeq !== window.__LOADSEQ__) return; // ‚úÖ
        const mesesData = dados.meses || {};
        const tr = document.createElement('tr');
        tr.dataset.id = m.id;
        tr.dataset.inativo = isInativo ? 'true' : 'false';
        tr.style.opacity = isInativo ? '0.45' : '1';


        // Busca telefone diretamente do script.js (mesma l√≥gica da imagem)
        const phoneFromMerchant = await getPhoneFromScript(m.id);
        if (mySeq !== window.__LOADSEQ__) return; // ‚úÖ
        tr.dataset.phone = (phoneFromMerchant || '').toString();



        // antes de montar tr.innerHTML
        const monthsHtml = ["01", "02", "03", "04", "05", "06", "07", "08", "09", "10", "11", "12"].map((mm, idx) => {
          const pago = !!(mesesData[mm]?.pago);
          if (!isInativo) {
            if (pago) totalPagos++;
            totalMeses++;
          }
          const label = ['Jan', 'Fev', 'Mar', 'Abr', 'Mai', 'Jun', 'Jul', 'Ago', 'Set', 'Out', 'Nov', 'Dez'][idx];
          return `<label class="mchip" data-mm="${mm}">
  <input type="checkbox" class="chk" data-mm="${mm}" ${pago ? 'checked' : ''}/>
  <span translate="no">${label}</span>
</label>`;

        }).join('');
        const isPaidNow = computeStatusForRow(mesesData);
        // conta s√≥ clientes ATIVOS (os inativos n√£o entram na cobran√ßa)
        if (!isInativo) {
          totalClientesAtivos++;
          if (isPaidNow) pagosMesAtual++;
        }


        const entradaEmDate = m.entradaEm?.toDate ? m.entradaEm.toDate() : null;
        const entradaEmTxt = entradaEmDate ? formatMesAnoPt(entradaEmDate) : '‚Äî';

        const entradaDate = (m.entradaEm?.toDate ? m.entradaEm.toDate() : null);
        const entradaYm = entradaDate
          ? `${entradaDate.getFullYear()}-${String(entradaDate.getMonth() + 1).padStart(2, '0')}`
          : '';

        tr.dataset.entradaYm = entradaYm; // vamos usar no PIX tamb√©m


        tr.innerHTML = `
  <td class="idx">${i}</td>
  <td class="rowwrap">
    <div class="row-scroll">


     <div class="rcell status">
  <div class="status-title">
    <span class="cliente-nome" title="${escapeHtml(m.name || m.id)}">
      ${escapeHtml(m.name || m.id)}
    </span>
    <!-- mant√©m compat√≠vel com o filtro -->
    <span class="sr-only nome-holder">${escapeHtml(m.name || m.id)}</span>
  </div>
  <div class="muted" style="margin:4px 0 6px;">
  Entrou em: <strong>${entradaEmTxt}</strong>
</div>


<div class="status-row">
  <div class="status-holder">${renderStatusChip(isPaidNow)}</div>

  <button class="btn-toggle-ativo btn-icon"
    title="Ativar / Inativar cliente"
    data-ativo="${m.ativo !== false}">
    ${m.ativo === false ? 'üö´' : 'üü¢'}
  </button>


  <button class="btn-save btn-icon" title="Salvar altera√ß√µes">üíæ</button>
  <button class="btn-icon btn-pix" title="Gerar QR Code PIX">üîó</button>
</div>

</div>




      <div class="rcell payer">
        <div class="label muted">Pagador</div>
        <input type="text" class="inp-nome" value="${escapeHtml(dados.pagadorPadrao || '')}" placeholder="ex.: Nome" />
      </div>

      <div class="rcell obs">
        <div class="label muted">Observa√ß√µes</div>
        <textarea class="inp-obs" placeholder="-">${escapeHtml(dados.observacao || '')}</textarea>
      </div>

      <div class="label muted" style="margin:6px 0 4px;">Entrada<br><input class="inp-entrada" type="month" value="${entradaYm}" style="width:100%; margin-bottom:6px; color:#1f1f1f" /></div>


      <div class="rcell meses">
        <div class="label muted">Meses - <button class="btn-allmonths btn-icon" title="Marcar todos os meses como pago">‚úÖ12</button></div>
        <div class="months"><div class="months-scroll">${monthsHtml}</div></div>
      </div>
    </div>
  </td>`;

        applyEntradaUI(tr, entradaYm);




        tbody.appendChild(tr);

        const inpEntrada = tr.querySelector('.inp-entrada');
        if (inpEntrada) {
          inpEntrada.addEventListener('change', () => {
            applyEntradaUI(tr, (inpEntrada.value || '').trim());
          });
        }


        // sempre que marcar/desmarcar um m√™s, recalcula o status da linha
        tr.querySelector('.months').addEventListener('change', (e) => {
          if (!e.target.matches('.chk')) return;
          // s√≥ precisa reavaliar quando o m√™s alterado √© o m√™s atual
          const cur = getCurrentMonthKey();
          if (e.target.getAttribute('data-mm') === cur) {
            updateRowStatusFromCheckboxes(tr);
          }
        });
        carregados++;

        const pct = Math.round((carregados / total) * 100);
        loaderBar.style.width = pct + '%';
        loaderPct.textContent = pct + '%';
        loaderText.textContent = `Carregando ${carregados} de ${total} clientes‚Ä¶`;

      }
      if (mySeq !== window.__LOADSEQ__) return; // ‚úÖ
      const faltamMesAtual = Math.max(0, totalClientesAtivos - pagosMesAtual);
      updateSummary(pagosMesAtual, totalClientesAtivos, faltamMesAtual);
      applyViewAndFilter();


      loaderText.textContent = 'Conclu√≠do';
      loaderBar.style.width = '100%';
      loaderPct.textContent = '100%';

      document.querySelectorAll('.row-scroll').forEach(enableDragScroll);

      setTimeout(() => {
        loaderBox.style.display = 'none';
      }, 400);

    }



    function updateSummary(pagosMesAtual, totalClientesAtivos, faltamMesAtual) {
      const pct = totalClientesAtivos ? Math.round((pagosMesAtual / totalClientesAtivos) * 100) : 0;
      sumario.textContent = `Pagos (m√™s): ${pagosMesAtual}/${totalClientesAtivos} (${pct}%) ‚Ä¢ Faltam: ${faltamMesAtual}`;
    }


    function applyViewAndFilter() {
      const q = filtro.value.trim().toLowerCase();

      let idx = 0;
      Array.from(tbody.children).forEach(tr => {
        const isInativo = tr.dataset.inativo === 'true';

        // modo exclusivo (ativos/inativos)
        const passaModo = window.__SHOW_INATIVOS__ ? isInativo : !isInativo;

        // status pago/aberto (baseado no chip da linha: "Pago" ou "Pendente")
        const statusTxt = (tr.querySelector('.status-holder')?.textContent || '').toLowerCase();
        const isPago = statusTxt.includes('pago');
        const isAberto = !isPago;

        let passaStatus = true;
        if (window.__FILTER_PAGO__) passaStatus = isPago;
        if (window.__FILTER_ABERTO__) passaStatus = isAberto;

        // busca
        const nome = (tr.querySelector('.nome-holder')?.textContent || '').toLowerCase();
        const passaBusca = (!q || nome.includes(q) || statusTxt.includes(q));

        const show = passaModo && passaStatus && passaBusca;
        tr.style.display = show ? '' : 'none';

        if (show) {
          idx++;
          const tdIdx = tr.querySelector('td.idx');
          if (tdIdx) tdIdx.textContent = String(idx);
        }
      });
    }

    // Marcar/Desmarcar todos os meses do cliente (toggle)
    tbody.addEventListener('click', (ev) => {
      const btnAll = ev.target.closest('.btn-allmonths');
      if (!btnAll) return;

      const tr = btnAll.closest('tr');
      const chks = Array.from(tr.querySelectorAll('.months .chk'));
      if (!chks.length) return;

      // Se TODOS estiverem marcados -> desmarca tudo. Sen√£o -> marca tudo.
      const allChecked = chks.every(c => c.checked);
      chks.forEach(c => { c.checked = !allChecked; });

      // Atualiza o chip do m√™s atual
      updateRowStatusFromCheckboxes(tr);

      // Feedback visual no bot√£o
      btnAll.textContent = allChecked ? '‚¨ú12' : '‚úÖ12';
    });



    tbody.addEventListener('click', async (ev) => {
      const btn = ev.target.closest('.btn-save');
      if (!btn) return;
      const tr = btn.closest('tr');
      btn.disabled = true; btn.textContent = 'Salvando‚Ä¶';
      try {
        const merchantId = tr.dataset.id;
        const year = selAno.value;
        const inpNome = tr.querySelector('.inp-nome');
        const inpObs = tr.querySelector('.inp-obs');
        const chks = Array.from(tr.querySelectorAll('.months .chk'));
        const meses = {};
        chks.forEach(c => {
          const mm = c.getAttribute('data-mm'); // "01".."12"
          meses[mm] = { pago: !!c.checked, updatedAt: serverTimestamp(), by: (auth.currentUser?.uid || null) };
        });

        await saveReceb(year, merchantId, { pagadorPadrao: inpNome.value.trim(), observacao: inpObs.value.trim(), meses });
        // üîπ salva entradaEm (m√™s/ano) no merchants
        const inpEntrada = tr.querySelector('.inp-entrada');
        const ym = (inpEntrada?.value || '').trim(); // "YYYY-MM"

        if (ym) {
          const [yy, mm] = ym.split('-').map(Number);
          const dt = new Date(yy, (mm - 1), 1);

          await updateDoc(doc(db, 'merchants', merchantId), {
            entradaEm: Timestamp.fromDate(dt)
          });

          tr.dataset.entradaYm = ym; // mant√©m atualizado p/ PIX
        }

        updateRowStatusFromCheckboxes(tr);

        btn.textContent = '‚úÖ';
        setTimeout(() => btn.textContent = 'üíæ', 1000);
      } catch (e) { console.error(e); btn.textContent = 'Erro'; setTimeout(() => btn.textContent = 'Atualizar', 1200); }
      finally { btn.disabled = false }
    });

    tbody.addEventListener('click', async (ev) => {
      const btnAtivo = ev.target.closest('.btn-toggle-ativo');
      if (!btnAtivo) return;

      const tr = btnAtivo.closest('tr');
      const merchantId = tr.dataset.id;
      const ativoAtual = btnAtivo.dataset.ativo === 'true';
      const novoAtivo = !ativoAtual;

      try {
        await updateDoc(doc(db, 'merchants', merchantId), {
          ativo: novoAtivo
        });

        btnAtivo.dataset.ativo = String(novoAtivo);
        btnAtivo.textContent = novoAtivo ? 'üü¢' : 'üö´';

        tr.style.opacity = novoAtivo ? '1' : '0.45';
        tr.dataset.inativo = novoAtivo ? 'false' : 'true';
      } catch (e) {
        console.error(e);
        alert('Erro ao atualizar status do cliente.');
      }
    });



    // Abre um mini-modal para escolher o tipo da cobran√ßa (com op√ß√£o de Valor Livre)
    // callback recebe:
    // - string: "MENSAL" | "SEMESTRAL" | "ANUAL"  (compat√≠vel)
    // - ou objeto: { tipo: "LIVRE", modo: "EXTRA"|"FINAL", base: "MENSAL"|"SEMESTRAL"|"ANUAL", valor: number, ref: string }
    function abrirModalTipoCobranca(totalMensal, callback) {
      const modal = document.createElement('div');
      modal.className = 'modal-pix';

      const totalMensalTxt = totalMensal.toFixed(2).replace('.', ',');

      modal.innerHTML = `
    <div class="modal-box">
      <h3>Gerar cobran√ßa</h3>
      <p style="font-size:13px; color:#e3e7ee; margin-bottom:10px;">
        Escolha o tipo de cobran√ßa para gerar o PIX.
      </p>

      <div style="display:flex; flex-direction:column; gap:8px; text-align:left; font-size:13px;">
        <button class="btn-tipo" data-tipo="MENSAL">
          üí≥ Mensal ‚Äì R$ ${totalMensalTxt}
        </button>
        <button class="btn-tipo" data-tipo="SEMESTRAL">
          üìÜ Semestral ‚Äì R$ ${VALOR_SEMESTRAL.toFixed(2).replace('.', ',')}
        </button>
        <button class="btn-tipo" data-tipo="ANUAL">
          üóìÔ∏è Anual ‚Äì R$ ${VALOR_ANUAL.toFixed(2).replace('.', ',')}
        </button>

        <button class="btn-tipo-livre" style="background:#0f141b;color:#e3e7ee;border:1px solid #182029;">
          ‚úèÔ∏è Valor livre (com refer√™ncia)
        </button>

        <div class="livre-box" style="display:none; margin-top:6px; padding:10px; border:1px solid #182029; border-radius:12px; background:#0f141b;">
          <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:center; margin-bottom:10px;">
            <label style="display:flex; gap:6px; align-items:center; font-size:12px; color:#e3e7ee;">
              <input type="radio" name="livreModo" value="EXTRA" checked />
              Extra (somar)
            </label>
            <label style="display:flex; gap:6px; align-items:center; font-size:12px; color:#e3e7ee;">
              <input type="radio" name="livreModo" value="FINAL" />
              Valor final (avulso)
            </label>

            <div class="livre-base-wrap" style="display:flex; gap:6px; align-items:center; margin-left:auto;">
              <span style="font-size:12px; color:#9aa6b2;">Somar em cima de:</span>
              <select class="livre-base" style="padding:6px 8px; border-radius:10px;">
                <option value="MENSAL" selected>Mensal</option>
                <option value="SEMESTRAL">Semestral</option>
                <option value="ANUAL">Anual</option>
              </select>
            </div>
          </div>

          <div style="display:grid; gap:8px;">
            <input class="livre-valor" type="text" inputmode="decimal" placeholder="Valor (ex.: 50 ou 75,90)" />
            <input class="livre-ref" type="text" placeholder="Refer√™ncia (ex.: divulga√ß√£o extra, ajuste, desconto‚Ä¶)" />
          </div>

          <button class="btn-livre-confirm" style="margin-top:10px; width:100%;">Gerar PIX</button>

          <div class="muted" style="margin-top:8px;">
            Dica: use ‚ÄúExtra‚Äù para somar com o plano e ‚ÄúValor final‚Äù para cobrar somente o valor digitado.
          </div>
        </div>
      </div>

      <button class="btn-close" style="margin-top:12px;">Fechar</button>
    </div>
  `;

      document.body.appendChild(modal);

      modal.addEventListener('click', (e) => {
        if (e.target === modal) modal.remove();
      });

      // bot√µes padr√£o
      modal.querySelectorAll('.btn-tipo').forEach(btn => {
        btn.addEventListener('click', () => {
          const tipo = btn.getAttribute('data-tipo');
          callback(tipo); // mant√©m compatibilidade
          modal.remove();
        });
      });

      // Valor livre
      const btnLivre = modal.querySelector('.btn-tipo-livre');
      const livreBox = modal.querySelector('.livre-box');
      const inpValor = modal.querySelector('.livre-valor');
      const inpRef = modal.querySelector('.livre-ref');
      const selBase = modal.querySelector('.livre-base');
      const baseWrap = modal.querySelector('.livre-base-wrap');

      function getModo() {
        const checked = modal.querySelector('input[name="livreModo"]:checked');
        return checked ? checked.value : 'EXTRA';
      }

      function syncUI() {
        const modo = getModo();
        // base s√≥ aparece em EXTRA
        if (baseWrap) baseWrap.style.display = (modo === 'EXTRA') ? 'flex' : 'none';
      }

      modal.querySelectorAll('input[name="livreModo"]').forEach(r => {
        r.addEventListener('change', syncUI);
      });

      btnLivre.addEventListener('click', () => {
        livreBox.style.display = (livreBox.style.display === 'none') ? 'block' : 'none';
        syncUI();
        setTimeout(() => inpValor && inpValor.focus(), 50);
      });

      modal.querySelector('.btn-livre-confirm').addEventListener('click', () => {
        const modo = getModo(); // EXTRA | FINAL
        const base = (selBase && selBase.value) ? selBase.value : 'MENSAL';

        let vRaw = (inpValor?.value || '').trim();
        vRaw = vRaw.replace(/\s/g, '').replace('.', '').replace(',', '.'); // permite "1.234,56"
        const valorNum = parseFloat(vRaw);

        const ref = (inpRef?.value || '').trim();

        if (!valorNum || isNaN(valorNum) || valorNum <= 0) {
          alert('Digite um valor v√°lido.');
          return;
        }
        if (!ref) {
          alert('Digite uma refer√™ncia (ex.: divulga√ß√£o extra, ajuste, desconto‚Ä¶).');
          return;
        }

        callback({ tipo: 'LIVRE', modo, base, valor: valorNum, ref });
        modal.remove();
      });

      modal.querySelector('.btn-close').onclick = () => modal.remove();
    }

    // Listener para o bot√£o PIX de cada linha
    // Listener para o bot√£o PIX de cada linha
    tbody.addEventListener('click', async (ev) => {
      const btnPix = ev.target.closest('.btn-pix');
      if (!btnPix) return;

      const tr = btnPix.closest('tr');
      const isAtivo = tr.querySelector('.btn-toggle-ativo')?.dataset.ativo !== 'false';

      if (!isAtivo) {
        alert('Este cliente est√° inativo e n√£o entra em cobran√ßas.');
        return;
      }

      const merchantId = tr.dataset.id;   // id do com√©rcio (igual ao do script.js / merchants)
      window.__PIX_MERCHANT_ID__ = merchantId;

      const nomeComercio = tr.querySelector('.nome-holder').textContent.trim();

      const chks = Array.from(tr.querySelectorAll('.months .chk'));
      const mesesNomes = ['Jan.', 'Fev.', 'Mar.', 'Abr.', 'Mai.', 'Jun.', 'Jul.', 'Ago.', 'Set.', 'Out.', 'Nov.', 'Dez.'];
      let totalMensal = 0;
      const mesesDevidos = [];


      const anoSel = Number(selAno.value);
      const ymEntrada = (tr.dataset.entradaYm || '').trim(); // "YYYY-MM"

      // startMonth: 1..12 (m√™s m√≠nimo a cobrar no ano selecionado)
      let startMonth = 1;

      if (ymEntrada) {
        const [yy, mm] = ymEntrada.split('-').map(Number);

        if (yy > anoSel) startMonth = 13;        // entrou depois desse ano
        else if (yy === anoSel) startMonth = mm; // entrou nesse ano: cobra do m√™s de entrada pra frente
        else startMonth = 1;                     // entrou antes: cobra o ano todo (se tiver pend√™ncia)
      }

      // zera e calcula s√≥ UMA vez
      totalMensal = 0;
      mesesDevidos.length = 0;

      chks.forEach((c, idx) => {
        const mes = idx + 1; // 1..12
        if (mes < startMonth) return; // ignora meses antes da entrada

        if (!c.checked) {
          totalMensal += VALOR_MENSAL;
          mesesDevidos.push(mesesNomes[idx]);
        }
      });




      // nome do cliente: usa o pagador se tiver, sen√£o o nome do com√©rcio
      const pagadorNome = tr.querySelector('.inp-nome')?.value.trim() || '';
      const nomeCliente = pagadorNome || nomeComercio;

      // Abre modal para escolher tipo de cobran√ßa
      // Abre modal para escolher tipo de cobran√ßa
      abrirModalTipoCobranca(totalMensal, async (res) => {
        let valorFinal = 0;
        let mesesInfo = [];
        let tipoExibicao = '';      // o que aparece no card (Plano ‚Ä¢ ...)
        let tipoBaseVig = '';       // usado para vig√™ncia (MENSAL/SEMESTRAL/ANUAL ou vazio p/ avulso)
        let livreInfo = null;

        // compatibilidade: caso venha string (MENSAL/SEMESTRAL/ANUAL)
        if (typeof res === 'string') {
          const tipoSelecionado = res;

          if (tipoSelecionado === 'MENSAL') {
            if (totalMensal <= 0) {
              alert('Nenhum m√™s pendente para cobran√ßa mensal.');
              return;
            }
            valorFinal = totalMensal;
            mesesInfo = mesesDevidos;
            tipoExibicao = 'MENSAL';
            tipoBaseVig = 'MENSAL';

          } else if (tipoSelecionado === 'SEMESTRAL') {
            valorFinal = VALOR_SEMESTRAL;
            mesesInfo = ['Plano semestral'];
            tipoExibicao = 'SEMESTRAL';
            tipoBaseVig = 'SEMESTRAL';

          } else if (tipoSelecionado === 'ANUAL') {
            valorFinal = VALOR_ANUAL;
            mesesInfo = ['Plano Anual'];
            tipoExibicao = 'ANUAL';
            tipoBaseVig = 'ANUAL';

          } else {
            return;
          }

          // üëâ AQUI buscamos a foto no script.js pelo merchantId
          const fotoPerfilUrl = await getProfileUrlFromScript(merchantId);
          const phoneCliente = tr.dataset.phone || '';

          const brcode = gerarBRCodePix(nomeCliente, valorFinal, tipoExibicao);
          abrirModalPIX(
            brcode,
            valorFinal,
            mesesInfo,
            tipoExibicao,
            await getNameFromScript(merchantId),
            merchantId,
            fotoPerfilUrl,
            phoneCliente,
            tipoBaseVig,
            livreInfo
          );
          return;
        }

        // Valor livre (novo)
        if (res && res.tipo === 'LIVRE') {
          const modo = (res.modo || 'EXTRA').toUpperCase();      // EXTRA | FINAL
          const base = (res.base || 'MENSAL').toUpperCase();     // MENSAL | SEMESTRAL | ANUAL
          const valorLivre = Number(res.valor || 0);
          const ref = (res.ref || '').trim();

          if (!valorLivre || valorLivre <= 0 || !ref) return;

          // define base (se for EXTRA)
          let baseValor = 0;
          let baseMesesInfo = [];
          let baseTipo = '';

          if (modo === 'EXTRA') {
            baseTipo = base;

            if (base === 'MENSAL') {
              if (totalMensal <= 0) {
                alert('Nenhum m√™s pendente para somar no mensal.');
                return;
              }
              baseValor = totalMensal;
              baseMesesInfo = mesesDevidos;

            } else if (base === 'SEMESTRAL') {
              baseValor = VALOR_SEMESTRAL;
              baseMesesInfo = ['Plano semestral'];

            } else if (base === 'ANUAL') {
              baseValor = VALOR_ANUAL;
              baseMesesInfo = ['Plano anual'];

            } else {
              baseTipo = 'MENSAL';
              baseValor = totalMensal;
              baseMesesInfo = mesesDevidos;
            }

            valorFinal = baseValor + valorLivre;
            mesesInfo = baseMesesInfo;
            tipoExibicao = `${baseTipo}+EXTRA`;
            tipoBaseVig = baseTipo;

            livreInfo = {
              modo: 'EXTRA',
              baseTipo,
              baseValor,
              valorLivre,
              ref
            };

          } else {
            // FINAL = avulso (n√£o soma com nenhum plano)
            valorFinal = valorLivre;
            mesesInfo = ['Cobran√ßa avulsa'];
            tipoExibicao = 'AVULSO';
            tipoBaseVig = ''; // vig√™ncia especial (avulso)

            livreInfo = {
              modo: 'FINAL',
              valorLivre,
              ref
            };
          }

          const fotoPerfilUrl = await getProfileUrlFromScript(merchantId);
          const phoneCliente = tr.dataset.phone || '';

          const brcode = gerarBRCodePix(nomeCliente, valorFinal, tipoExibicao);
          abrirModalPIX(
            brcode,
            valorFinal,
            mesesInfo,
            tipoExibicao,
            await getNameFromScript(merchantId),
            merchantId,
            fotoPerfilUrl,
            phoneCliente,
            tipoBaseVig,
            livreInfo
          );

          return;
        }
      });
    });







    // ===== CSV =====
    function exportCSV() {
      const year = selAno.value;
      const rows = [['status', 'nome', 'pagador', 'observacao', 'jan', 'fev', 'mar', 'abr', 'mai', 'jun', 'jul', 'ago', 'set', 'out', 'nov', 'dez']];

      Array.from(tbody.children).forEach(tr => {
        if (tr.style.display === 'none') return;
        const status = (tr.querySelector('.status-holder')?.textContent || '').trim();
        const nome = (tr.querySelector('.nome-holder')?.textContent || '').trim();
        const pagador = tr.querySelector('.inp-nome')?.value.trim() || '';
        const obs = tr.querySelector('.inp-obs')?.value.trim() || '';
        const chks = Array.from(tr.querySelectorAll('.months .chk')).map(c => c.checked ? '1' : '0');
        rows.push([status, nome, pagador, obs, ...chks]);
      });

      const csv = rows.map(r => r.map(s => '"' + (String(s).replace(/"/g, '""')) + '"').join(',')).join('\n');
      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const a = document.createElement('a'); a.href = URL.createObjectURL(blob);
      a.download = `recebimentos-${year}.csv`; a.click();
    }

    // ===== UTILS =====
    function escapeHtml(s) { return String(s).replace(/[&<>"]/g, m => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;' }[m])) }





    // Enable click-and-drag horizontal scroll (mouse) ‚Äî no mobile j√° funciona por toque
    function enableDragScroll(el) {
      let isDown = false, startX = 0, scrollStart = 0;
      el.addEventListener('mousedown', (e) => {
        isDown = true;
        startX = e.pageX;
        scrollStart = el.scrollLeft;
        el.classList.add('dragging');
      });
      window.addEventListener('mouseup', () => { isDown = false; el.classList.remove('dragging'); });
      window.addEventListener('mousemove', (e) => {
        if (!isDown) return;
        const dx = e.pageX - startX;
        el.scrollLeft = scrollStart - dx;
      });
    }

    // aplica no container geral e em cada linha
    document.addEventListener('DOMContentLoaded', () => {
      const tw = document.querySelector('.table-wrap');
      if (tw) enableDragScroll(tw);
    });

    ////////////////////////////////////////// pix
    ////////////////////////////////////////// PIX

    // valor de cada mensalidade pendente
    const VALOR_MENSAL = 30.00; // ajuste se quiser
    const VALOR_SEMESTRAL = 150.00;
    const VALOR_ANUAL = 250.00;

    // helper para montar campos EMV (ID + tamanho + valor)
    function emvField(id, value) {
      const len = String(value.length).padStart(2, '0');
      return id + len + value;
    }

    // c√°lculo do CRC16 CCITT (obrigat√≥rio no BR Code)
    function crc16(str) {
      let crc = 0xFFFF;
      for (let i = 0; i < str.length; i++) {
        crc ^= str.charCodeAt(i) << 8;
        for (let j = 0; j < 8; j++) {
          if (crc & 0x8000) {
            crc = ((crc << 1) ^ 0x1021) & 0xFFFF;
          } else {
            crc = (crc << 1) & 0xFFFF;
          }
        }
      }
      return crc.toString(16).toUpperCase().padStart(4, '0');
    }




    // Nome e cidade do recebedor, exatamente como na conta PIX do CNPJ
    const NOME_PIX_RECEBEDOR = 'OLA CARLOPOLIS';
    const CIDADE_PIX_RECEBEDOR = 'CARLOPOLIS';

    // Gera BR Code PIX est√°tico (PIX copia e cola) usando a chave CNPJ 52.608.228/0001-62
    // _nomeClienteIgnorado e _tipoLabel s√£o usados s√≥ para texto em WhatsApp / tela
    function gerarBRCodePix(_nomeClienteIgnorado, valor, _tipoLabel = 'MENSAL') {
      const pixKey = '52608228000162';   // CNPJ s√≥ com n√∫meros
      const gui = 'BR.GOV.BCB.PIX';   // GUI em MAI√öSCULO, padr√£o usado nos exemplos

      // Recebedor sempre √© o dono da chave (seu CNPJ)
      const nomeComerciante = NOME_PIX_RECEBEDOR;   // m√°x. 25 caracteres (j√° est√° ok)
      const cidade = CIDADE_PIX_RECEBEDOR; // m√°x. 15 caracteres (j√° est√° ok)

      // 26 = Merchant Account Information (PIX est√°tico)
      const merchantAccountInfo =
        emvField('00', gui) +      // GUI: BR.GOV.BCB.PIX
        emvField('01', pixKey);    // chave (CNPJ)

      const merchantAccountField = emvField('26', merchantAccountInfo);

      // Valor fixo no payload
      const valorStr = valor.toFixed(2); // ex: "90.00"

      // Campo 62 = Additional Data Field ‚Ä¢ subcampo 05 = TxId
      // Aqui uso "***" (mesmo padr√£o do exemplo oficial do Bacen)
      const additionalData = emvField('05', 'olaCarlopolis');  // 05 = TxId dentro do 62

      // Payload EMV no padr√£o BR Code (PIX est√°tico):
      // 00 = formato
      // (N√ÉO usamos 01 aqui ‚Üí QR est√°tico)
      // 26 = merchant account (PIX)
      // 52,53,54,58,59,60
      // 62 = TxId
      let payload =
        emvField('00', '01') +         // Payload Format Indicator
        merchantAccountField +         // Merchant Account Info (GUI + chave)
        emvField('52', '0000') +       // MCC gen√©rico
        emvField('53', '986') +        // Moeda BRL
        emvField('54', valorStr) +     // Valor
        emvField('58', 'BR') +         // Pa√≠s
        emvField('59', nomeComerciante) + // Nome recebedor
        emvField('60', cidade) +       // Cidade
        emvField('62', additionalData); // Additional Data Field Template (TxId = "***")

      // Campo 63 = CRC16 (obrigat√≥rio)
      const toCrc = payload + '6304';
      const crc = crc16(toCrc);

      return toCrc + crc;
    }







    function formatMesAnoPt(date) {
      const meses = ['jan', 'fev', 'mar', 'abr', 'mai', 'jun', 'jul', 'ago', 'set', 'out', 'nov', 'dez'];
      const mes = meses[date.getMonth()];
      const ano2 = String(date.getFullYear()).slice(-2);
      return `${mes}/${ano2}`;
    }


    function abrirModalPIX(
      linha,
      valor,
      mesesDevidos,
      tipoLabel = 'MENSAL',
      nomeCliente = '',
      merchantId = '',
      fotoPerfilUrl = '',
      phoneCliente = '',
      tipoBaseVigencia = '',
      livreInfo = null
    ) {
      const modal = document.createElement("div");
      modal.className = "modal-pix";

      const mesesTexto = (mesesDevidos && mesesDevidos.length)
        ? mesesDevidos.join(', ')
        : '‚Äî';

      // üîπ primeiro define o tipo normalizado
      // üîπ tipoBaseSan = usado para vig√™ncia (mensal/semestral/anual). tipoExibSan = o que aparece no cart√£o.
      const tipoBaseSan = (tipoBaseVigencia || tipoLabel || 'MENSAL').toString().toUpperCase();
      const tipoExibSan = (tipoLabel || tipoBaseSan).toString().toUpperCase();

      // (se quiser usar em algum lugar, agora funciona)
      const planoId = `OLA_CARLOPOLIS_${tipoExibSan}`;

      const nomeMostrar = (nomeCliente && nomeCliente.trim()) || 'Cliente';
      const valorBr = valor.toFixed(2).replace('.', ',');

      // üîπ c√°lculo da vig√™ncia (in√≠cio = m√™s atual)  
      const hoje = new Date();
      const inicio = new Date(hoje.getFullYear(), hoje.getMonth(), 1); // m√™s de refer√™ncia
      const fim = new Date(inicio);

      if (tipoBaseSan === 'ANUAL') {
        // 12 meses de vig√™ncia a partir do m√™s atual
        fim.setFullYear(fim.getFullYear() + 1);
      } else if (tipoBaseSan === 'SEMESTRAL') {
        // 6 meses contando o m√™s atual ‚Üí +5 meses
        fim.setMonth(fim.getMonth() + 5);
      } else {
        // MENSAL: s√≥ o m√™s de pagamento (inicio = fim)
        // se quiser, pode at√© deixar assim explicitamente:
        fim.setMonth(fim.getMonth());
      }
      let vigenciaHtml = '';

      // üîπ s√≥ gera vig√™ncia se N√ÉO for avulso
      if (tipoBaseSan === 'MENSAL' || tipoBaseSan === 'SEMESTRAL' || tipoBaseSan === 'ANUAL') {

        const hoje = new Date();
        const inicio = new Date(hoje.getFullYear(), hoje.getMonth(), 1);
        const fim = new Date(inicio);

        if (tipoBaseSan === 'ANUAL') {
          fim.setFullYear(fim.getFullYear() + 1);
        } else if (tipoBaseSan === 'SEMESTRAL') {
          fim.setMonth(fim.getMonth() + 5);
        } else {
          fim.setMonth(fim.getMonth());
        }

        if (tipoBaseSan === 'MENSAL') {
          vigenciaHtml = `
      <div style="margin-top:4px;">
        <strong>Vig√™ncia:</strong> ${formatMesAnoPt(inicio)}
      </div>
    `;
        } else {
          vigenciaHtml = `
      <div style="margin-top:4px;">
        <strong>Vig√™ncia:</strong> ${formatMesAnoPt(inicio)} a ${formatMesAnoPt(fim)}
      </div>
    `;
        }
      }

      // üëâ se for AVULSO, vigenciaHtml fica vazio e N√ÉO aparece nada
      const phoneClean = (phoneCliente || '').toString().trim();
      const phoneHtml = phoneClean ? `` : '';

      let detalheMesesHtml = '';

      // üîπ Plano normal
      if (tipoBaseSan === 'MENSAL') {
        detalheMesesHtml = `
    <div style="margin-top:4px;">
      <strong>Referente a:</strong> ${mesesTexto}
    </div>
  `;
      }

      // üîπ Semestral / Anual
      else if (tipoBaseSan === 'SEMESTRAL' || tipoBaseSan === 'ANUAL') {
        detalheMesesHtml = `
    <div style="margin-top:4px;">
      <strong>Referente a:</strong> Plano ${tipoBaseSan.toLowerCase()}
    </div>
  `;
      }

      // üîπ VALOR LIVRE ‚Äì AVULSO
      else if (livreInfo && livreInfo.modo === 'FINAL') {
        detalheMesesHtml = `
    <div style="margin-top:4px;">
      <strong>Referente a:</strong> ${escapeHtml(livreInfo.ref)}
    </div>
  `;
      }


      // üîπ detalhes do valor livre (extra ou avulso), aparece no cart√£o e no WhatsApp
      let livreHtml = '';
      if (livreInfo && typeof livreInfo === 'object') {
        const ref = (livreInfo.ref || '').toString().trim();
        if (livreInfo.modo === 'EXTRA') {
          const baseTipo = (livreInfo.baseTipo || tipoBaseSan || '').toString().toUpperCase();
          const baseValor = Number(livreInfo.baseValor || 0);
          const vLivre = Number(livreInfo.valorLivre || 0);

          livreHtml = `
      <div style="margin-top:6px; padding:10px; border:1px dashed rgba(93,212,255,.35); border-radius:12px; background:rgba(93,212,255,.06);">
        <div style="font-size:12px; letter-spacing:.08em; text-transform:uppercase; color:#bfcbd7;">
          Ajuste ‚Ä¢ Extra
        </div>
        <div style="margin-top:4px; font-size:12px;">
          <strong>Base:</strong> ${baseTipo} (R$ ${baseValor.toFixed(2).replace('.', ',')})
        </div>
        <div style="margin-top:4px; font-size:12px;">
          <strong>Extra:</strong> R$ ${vLivre.toFixed(2).replace('.', ',')}
        </div>
        <div style="margin-top:4px; font-size:12px;">
          <strong>Refer√™ncia:</strong> ${escapeHtml(ref || '‚Äî')}
        </div>
      </div>
    `;
        } else {
          // modo FINAL (avulso): n√£o exibe bloco extra no cart√£o
          livreHtml = '';
        }

      }

      // monta cart√£o premium
      modal.innerHTML = `
    <div class="modal-box">
      <h3>QR Code PIX</h3>

      <!-- CART√ÉO PREMIUM QUE VIRA IMAGEM -->
      <div id="pixCard" style="
        position:relative;
        width:336px;
        border-radius:24px;
        overflow:hidden;
        background:radial-gradient(circle at top,#1a2635,#050910);
        box-shadow:0 18px 40px rgba(0,0,0,.7);
        border:1px solid rgba(93,212,255,.25);
        margin:0 auto 16px;
      ">

        <!-- CAPA COM FOTO DO CLIENTE -->
        <div style="
          position:relative;
          width:100%;
          height:auto;
          overflow:hidden;
        ">
          ${(fotoPerfilUrl && fotoPerfilUrl.trim())
          ? `<img src="${fotoPerfilUrl.startsWith('/') ? fotoPerfilUrl : '/' + fotoPerfilUrl}"
                     alt="${escapeHtml(nomeMostrar)}"
                     style="width:100%;height:100%;object-fit:cover;">`
          : `<img src="/images/img_padrao_site/logo_.png"
                     alt="Ol√° Carl√≥polis"
                     style="width:100%;height:100%;object-fit:cover;">`
        }

          <!-- degrad√™ para leitura do texto -->
          <div style="
            position:absolute;
            inset:0;
            background:linear-gradient(to top, rgba(0,0,0,.8) 0%, rgba(0,0,0,.2) 1%, rgba(0,0,0,0) 0%);
          "></div>

          <!-- nome do cliente em cima da foto -->
          <div style="
            position:absolute;
            left:18px;
            right:18px;
            bottom:14px;
            display:flex;
            flex-direction:column;
            gap:2px;
          ">
            <span style="font-size:11px; text-transform:uppercase; letter-spacing:.12em; color:#9aa6b2;">
              Cliente
            </span>
            <span style="font-size:17px; font-weight:700; color:#f9fafb; text-shadow:0 2px 6px rgba(0,0,0,.8);">
              ${escapeHtml(nomeMostrar)}
            </span>
          </div>
        </div>

        <!-- CORPO DO CART√ÉO -->
        <div style="
          padding:14px 18px 16px;
          display:flex;
          flex-direction:column;
          gap:6px;
          color:#e3e7ee;
          font-size:13px;
        ">
          <div style="font-size:16px; text-transform:uppercase; letter-spacing:.14em; color:#bfcbd7;">
            Plano ‚Ä¢ ${tipoExibSan}
          </div>

          <!-- valor grande estilo PicPay -->
          <div style="margin-top:2px; font-size:24px; font-weight:700; color:#f9fafb;">
            R$ ${valorBr}
          </div>

          ${detalheMesesHtml}
          ${livreHtml}
          ${vigenciaHtml}
          ${phoneHtml}

          <div style="margin-top:6px; font-size:12px; letter-spacing: 0.1em;">
            <strong>Chave PIX (CNPJ):</strong><br>
            52.608.228/0001-62
          </div>

          <!-- bloco de marca centralizado -->
          <div style="
            margin-top:10px;
            font-size:11px;
            opacity:.9;
            display:flex;
            flex-direction:column;
            align-items:center;
            justify-content:center;
            gap:4px;
          ">
            <img src="/images/img_padrao_site/logo_.png"
                 alt="Ol√° Carl√≥polis"
                 style="
                   width:50px;
                   height:50px;
                   border-radius:10px;
                   object-fit:cover;
                   opacity:0.95;
                 ">
            <span>Marketing Ola Carlopolis</span>
          </div>
        </div>
      </div>

      <!-- √ÅREA FORA DO CART√ÉO: CNPJ + C√ìDIGO + BOT√ïES -->
      <div style="margin-top:10px; text-align:left; font-size:12px; color:#e3e7ee;">
        <div style="margin-bottom:8px; display:flex; flex-direction:column; gap:4px;">
          <div style="
            display:flex;
            align-items:center;
            justify-content:space-between;
            width:100%;
          ">
            <strong>Chave PIX (CNPJ):</strong>
          </div>

          <span id="cnpjPix">52.608.228/0001-62</span>

          <button class="btn-copy-cnpj" style="margin-top:4px; padding:4px 8px; font-size:12px;">
            üìã Copiar CNPJ
          </button>
        </div>

        <div>
          <strong>PIX copia e cola:</strong>
          <div id="linhaPix" class="pix-line" style="margin-top:4px;">
            ${linha}
          </div>
          <button class="btn-copy-line" style="margin-top:4px; padding:4px 8px; font-size:12px;">
            üìã Copiar c√≥digo
          </button>
        </div>
      </div>

      <button class="btn-download-img" style="margin-top:8px;">Baixar imagem</button>
      <button class="btn-whats" style="margin-top:8px; background:#25D366; color:#061018;">
        Enviar por WhatsApp
      </button>
      <button class="btn-close">Fechar</button>
    </div>
  `;

      document.body.appendChild(modal);

      // permite fechar clicando fora
      modal.addEventListener('click', (e) => {
        if (e.target === modal) modal.remove();
      });

      // Copiar s√≥ o CNPJ
      modal.querySelector(".btn-copy-cnpj").onclick = async () => {
        const cnpj = "52.608.228/0001-62";
        try {
          await navigator.clipboard.writeText(cnpj);
          alert("CNPJ copiado!");
        } catch (e) {
          console.error(e);
          alert("Erro ao copiar. Copie manualmente.");
        }
      };

      // Copiar s√≥ o c√≥digo PIX (copia e cola)
      modal.querySelector(".btn-copy-line").onclick = async () => {
        const copiaCola = document.getElementById("linhaPix").textContent.trim();
        try {
          await navigator.clipboard.writeText(copiaCola);
          alert("C√≥digo PIX (copia e cola) copiado!");
        } catch (e) {
          console.error(e);
          alert("Erro ao copiar. Copie manualmente.");
        }
      };

      // baixar cart√£o como imagem
      const btnDownload = modal.querySelector(".btn-download-img");
      btnDownload.onclick = async () => {
        const card = document.getElementById('pixCard');
        if (!window.html2canvas) {
          alert('html2canvas n√£o carregado. Verifique o script no final da p√°gina.');
          return;
        }
        const canvas = await html2canvas(card, { backgroundColor: '#050910', scale: 2 });
        const dataUrl = canvas.toDataURL('image/png');

        const a = document.createElement('a');
        a.href = dataUrl;
        a.download = `pix-${tipoLabel.toLowerCase()}-${valor.toFixed(2).replace('.', '_')}.png`;
        a.click();
      };

      const btnWhats = modal.querySelector(".btn-whats");
      btnWhats.onclick = async () => {
        let phone = (phoneCliente || '').toString();

        // 1) se n√£o veio no dataset, tenta Firestore
        if (!phone) {
          try {
            if (merchantId) {
              const mRef = doc(db, 'merchants', merchantId);
              const mSnap = await getDoc(mRef);
              if (mSnap.exists()) {
                const data = mSnap.data();
                phone =
                  (data.whatsapp || data.telefone || data.celular || data.phone || '').toString();
              }
            }
          } catch (e) {
            console.error('Erro ao buscar telefone do merchant (Firestore):', e);
          }
        }

        // 2) se ainda n√£o tiver, busca no script.js (mesmo lugar da imagem)
        if (!phone) {
          try {
            phone = await getPhoneFromScript(merchantId);
          } catch (e) {
            console.error('Erro ao buscar telefone no script.js:', e);
          }
        }

        if (!phone) {
          alert('Telefone do estabelecimento n√£o encontrado.\n' +
            'Cadastre o Whats/telefone no site (contact/whatsapp/telefone).');
          return;
        }

        // 3) normaliza o n√∫mero: s√≥ d√≠gitos, for√ßa DDI 55
        let numero = phone.replace(/\D/g, '');
        if (numero.startsWith('0')) numero = numero.slice(1);
        if (!numero.startsWith('55')) numero = '55' + numero;

        // 4) monta a mensagem do WhatsApp
        // 4) monta a mensagem do WhatsApp
        let livreTxt = '';
        if (livreInfo && typeof livreInfo === 'object') {
          const ref = (livreInfo.ref || '').toString().trim();
          if (livreInfo.modo === 'EXTRA') {
            const baseTipo = (livreInfo.baseTipo || tipoBaseSan || '').toString().toUpperCase();
            const baseValor = Number(livreInfo.baseValor || 0);
            const vLivre = Number(livreInfo.valorLivre || 0);
            livreTxt = `

Ajuste (extra):
Base: ${baseTipo} (R$ ${baseValor.toFixed(2).replace('.', ',')})
Extra: R$ ${vLivre.toFixed(2).replace('.', ',')}
Refer√™ncia: ${ref || '‚Äî'}`;
          } else {
            livreTxt = `

Refer√™ncia: ${ref || '‚Äî'}`;
          }
        }

        const msg =
          `Ol√°! Segue o PIX para pagamento no Ol√° Carl√≥polis.

Cliente: ${nomeMostrar}
Plano: ${tipoExibSan}
Valor total: R$ ${valorBr}${livreTxt}

Chave PIX (CNPJ):
52.608.228/0001-62

PIX copia e cola:
${linha}`;

        const url = `https://wa.me/${numero}?text=${encodeURIComponent(msg)}`;
        window.open(url, '_blank');
      };

      modal.querySelector(".btn-close").onclick = () => modal.remove();
    }







  </script>

  <script src="https://cdn.jsdelivr.net/npm/qrious/dist/qrious.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
</body>

</html>