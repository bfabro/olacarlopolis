input
  gain(4);
  loss(10);
  parcial(3.5);
  protecao(8);
var
  distancias                           : Array[1..5] of Integer;
  linhaCompra,linhaVenda               : Array[1..5] of Float;
  contadorCompra,contadorVenda         : Array[1..5] of Integer;
  precoEntradaCompra,precoEntradaVenda : Float;
  stopCompra,stopVenda                 : Float;
  minDia,maxDia                        : Float;
  diaAtual                             : Integer;
  i                                    : Integer;
  entrou                               : Boolean;
  limiteVenda                          : Integer;
  limiteCompra                         : Integer;
inicio
  // Distâncias das linhas
  distancias[1] := 14;
  distancias[2] := 28;
  distancias[3] := 45;
  distancias[4] := 60;
  distancias[5] := 75;
  // Troca de dia: reseta tudo
  if (DayOfMonth(Date) <> diaAtual) then
    begin
      diaAtual := DayOfMonth(Date);
      for i := 1 to 5 do
        begin
          linhaCompra[i] := 0;
          linhaVenda[i] := 0;
          contadorCompra[i] := 0;
          contadorVenda[i] := 0;
        end;
    end;
  if (ContadorDeCandle > 1) then
    begin
      minDia := LowD(0);
      maxDia := HighD(0);
      for i := 1 to 5 do
        begin
          linhaVenda[i] := minDia + distancias[i];
          linhaCompra[i] := maxDia - distancias[i];
          SetPlotColor(1,clvermelho);
          SetPlotWidth(1,2);
          SetPlotColor(2,clverde);
          SetPlotWidth(2,2);
          SetPlotColor(3,clazul);
          SetPlotWidth(3,2);
          SetPlotColor(4,clamarelo);
          SetPlotWidth(4,2);
          plot(linhaVenda);
          plot2(linhaCompra);
          plot3(minDia + 30);
          plot4(maxDia - 30);
        end;
      // Desenha linhas no gráfico
      for i := 1 to 5 do
        begin
          PlotN(i,linhaVenda[i]);
          PlotN(i + 5,linhaCompra[i]);
        end;
      // === ENTRADA VENDA ===
      entrou := False;
      if (Position = 0) then
        begin
          for i := 1 to 5 do
            begin
              if (i = 1) then
                limiteVenda := 1
              else 
                limiteVenda := 2;
              if (contadorVenda[i] < limiteVenda) and (High  >= linhaVenda[i]) and (entrou = False) then
                begin
                  SellShortAtMarket;
                  precoEntradaVenda := Close;
                  stopVenda := precoEntradaVenda + loss;
                  contadorVenda[i] := contadorVenda[i] + 1;
                  entrou := True;
                end;
            end;
        end;
      // Gerenciamento VENDA
      if (Position < 0) then
        begin
          if (Close <= precoEntradaVenda - gain) then
            BuyToCoverAtMarket
          else if (Close <= precoEntradaVenda - parcial) then
            stopVenda := precoEntradaVenda
          else if (Close >= precoEntradaVenda + protecao) then
            stopVenda := precoEntradaVenda;
          if (Close >= stopVenda) then
            BuyToCoverAtMarket;
        end;
      // === ENTRADA COMPRA ===
      entrou := False;
      if (Position = 0) then
        begin
          for i := 1 to 5 do
            begin
              if (i = 1) then
                limiteCompra := 1
              else 
                limiteCompra := 2;
              if (contadorCompra[i] < limiteCompra) and (Low  <= linhaCompra[i]) and (entrou = False) then
                begin
                  BuyAtMarket;
                  
                  precoEntradaCompra := Close;
                  stopCompra := precoEntradaCompra - loss;
                  contadorCompra[i] := contadorCompra[i] + 1;
                  entrou := True;
                end;
            end;
        end;
      // Gerenciamento COMPRA
      if (Position > 0) then
        begin
          if (Close >= precoEntradaCompra + gain) then
            SellShortAtMarket
          else if (Close >= precoEntradaCompra + parcial) then
            stopCompra := precoEntradaCompra
          else if (Close <= precoEntradaCompra - protecao) then
            stopCompra := precoEntradaCompra;
          if (Close <= stopCompra) then
            SellShortAtMarket;
        end;
    end;
end;